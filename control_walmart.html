<!DOCTYPE html>
<html class="light" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Zubale CR Systems | Logistics Control Center</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        enterprise: {
                            50: '#F8FAFC', 100: '#F1F5F9', 200: '#E2E8F0', 300: '#CBD5E1',
                            400: '#94A3B8', 600: '#475569', 700: '#334155', 800: '#1E293B', 900: '#0F172A',
                        },
                        accent: {
                            500: '#4F46E2', 600: '#4338CA',
                        }
                    }
                }
            }
        }
    </script>
    <style data-purpose="custom-ui-refinement">
        body { background-color: #F8FAFC; }
        .dark body { background-color: #0F172A; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); border: 1px solid #E2E8F0; }
        .dark .glass-card { background: rgba(30, 41, 59, 0.7); border: 1px solid #334155; }
        .stat-card-gradient { background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); }
        .dark .stat-card-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .toast { animation: slideInRight 0.4s ease, fadeOut 0.4s ease 2.6s forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>

<body class="font-sans antialiased bg-[#F8FAFC] text-enterprise-800 dark:bg-enterprise-900 dark:text-enterprise-100 transition-colors duration-200" onload="initTheme()">

    <input type="file" id="input-inyectar" class="hidden" accept=".xlsx,.xls,.csv" />
    <input type="file" id="input-soluciones" class="hidden" accept=".xlsx,.xls,.csv" />
    <input type="file" id="input-slot" class="hidden" accept=".xlsx,.xls,.csv" />

    <div id="toast-container" class="fixed top-20 right-6 z-[100] flex flex-col gap-2"></div>

    <header class="sticky top-0 z-40 w-full border-b border-enterprise-200 dark:border-enterprise-800 bg-white/80 dark:bg-enterprise-900/80 backdrop-blur-md">
        <div class="max-w-[1440px] mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <a href="index.html" class="flex items-center gap-2 px-4 py-2 bg-accent-500/10 text-accent-500 border border-accent-500/20 rounded-xl font-black text-[10px] uppercase tracking-wider hover:bg-accent-500 hover:text-white transition-all shadow-sm">
                    <span class="material-symbols-outlined text-sm">grid_view</span>
                    Hub Central
                </a>

                <div class="h-6 w-[1px] bg-enterprise-200 dark:bg-enterprise-800"></div>

                <div class="flex items-center space-x-4">
                    <div class="w-8 h-8 bg-accent-500 rounded-lg flex items-center justify-center text-white font-bold shadow-lg shadow-accent-500/20">Z</div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight text-enterprise-900 dark:text-white leading-none italic">Zubale <span class="text-accent-500">CR</span></h1>
                        <span class="text-[9px] uppercase tracking-widest text-enterprise-500 font-black">Control Center v2.0</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-3">
                <button class="p-2 w-10 h-10 flex items-center justify-center rounded-xl bg-enterprise-100 dark:bg-enterprise-800 border border-enterprise-200 dark:border-enterprise-700 text-lg hover:scale-105 transition-all shadow-sm" id="themeToggle">
                    ðŸŒ“
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1440px] mx-auto px-6 py-8">
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card-gradient p-5 rounded-2xl border border-enterprise-200 dark:border-enterprise-800 shadow-sm">
                <span class="text-[10px] font-black text-enterprise-500 uppercase tracking-widest">Batch 1</span>
                <div id="total-b1" class="text-3xl font-black text-enterprise-900 dark:text-white mt-1">0</div>
            </div>
            <div class="stat-card-gradient p-5 rounded-2xl border border-enterprise-200 dark:border-enterprise-800 shadow-sm">
                <span class="text-[10px] font-black text-enterprise-500 uppercase tracking-widest">Batch 2</span>
                <div id="total-b2" class="text-3xl font-black text-enterprise-900 dark:text-white mt-1">0</div>
            </div>
            <div class="stat-card-gradient p-5 rounded-2xl border border-enterprise-200 dark:border-enterprise-800 shadow-sm">
                <span class="text-[10px] font-black text-enterprise-500 uppercase tracking-widest">Soluciones</span>
                <div id="total-sols" class="text-2xl font-black text-enterprise-900 dark:text-white mt-1">0</div>
            </div>
            <div class="bg-enterprise-900 dark:bg-accent-600 p-5 rounded-2xl border border-enterprise-800 shadow-lg">
                <span class="text-[10px] font-black text-white/70 uppercase tracking-widest">Total General</span>
                <div id="gran-total" class="text-3xl font-black text-white mt-1">0</div>
            </div>
        </section>

        <section class="mb-8">
            <div class="glass-card p-6 rounded-[2rem] shadow-xl">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <h2 class="text-xs font-black text-enterprise-900 dark:text-white uppercase tracking-[0.2em] italic">Centro de Acciones</h2>
                    <div class="flex flex-wrap items-center gap-3">
                        <button onclick="document.getElementById('input-inyectar').click()" class="px-5 py-3 text-[10px] font-black bg-enterprise-800 dark:bg-enterprise-700 text-white rounded-xl hover:bg-enterprise-900 transition-all shadow-md uppercase tracking-wider">Inyectar Turno Anterior</button>
                        <button onclick="document.getElementById('input-soluciones').click()" class="px-5 py-3 text-[10px] font-black bg-white dark:bg-enterprise-800 text-enterprise-700 dark:text-enterprise-200 border border-enterprise-200 dark:border-enterprise-700 rounded-xl hover:bg-enterprise-50 transition-all uppercase tracking-wider">Cargar Soluciones</button>
                        <div class="flex items-center">
                            <select id="slot-selector" onchange="actualizarEstadoBoton()" class="px-3 py-3 text-[10px] font-black bg-white dark:bg-enterprise-800 border border-enterprise-200 dark:border-enterprise-700 rounded-l-xl outline-none text-enterprise-700 dark:text-white uppercase">
                                <option value="1">Slot 1</option><option value="2">Slot 2</option><option value="3">Slot 3</option><option value="4">Slot 4</option>
                                <option value="5">Slot 5</option><option value="6">Slot 6</option><option value="7">Slot 7</option><option value="8">Slot 8</option>
                            </select>
                            <button onclick="document.getElementById('input-slot').click()" class="px-5 py-3 text-[10px] font-black bg-accent-500 text-white rounded-r-xl hover:bg-accent-600 transition-all uppercase tracking-wider">Subir Slot</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-6 pt-4 border-t border-enterprise-100 dark:border-enterprise-700">
                    <p id="msg-bloqueo" class="text-[10px] font-black text-accent-500 uppercase tracking-widest italic">Slot 1: 0/2 Cargados</p>
                    <div class="flex items-center gap-3">
                        <button onclick="exportarExcel()" class="px-5 py-3 text-[10px] font-black bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition-all uppercase tracking-wider shadow-lg">Exportar Reporte</button>
                        <button onclick="limpiarTodo()" class="px-5 py-3 text-[10px] font-black border-2 border-red-500/20 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all uppercase tracking-wider">Reiniciar</button>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-enterprise-400 mb-6 italic">Estado de Tiendas</h3>
            <div id="tiendas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>
    </main>

    <script>
        // --- GESTIÃ“N DE TEMA PERSISTENTE ---
        function initTheme() {
            const saved = localStorage.getItem('zubale_theme');
            if(saved === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('zubale_theme', isDark ? 'dark' : 'light');
        });

        // --- LÃ“GICA DE NEGOCIO ---
        const allStores = ["Wm Alajuela", "Wm Heredia", "Wm Heredia Este", "Wm Tibas", "Wm Escazu", "Wm Santa Ana", "Wm Guadalupe", "Wm Desamparados"];
        const batch1Stores = ["Wm Alajuela", "Wm Heredia", "Wm Heredia Este", "Wm Tibas"];
        let db = JSON.parse(localStorage.getItem('zubale_db')) || {};
        let locks = JSON.parse(localStorage.getItem('zubale_locks')) || {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0};

        allStores.forEach(name => { if (!db[name]) db[name] = { slots: Array(8).fill(0), sol: 0 }; });

        function buscarTiendaEnFila(fila) {
            const txt = Object.values(fila).join("|").toUpperCase();
            if (txt.includes("HEREDIA ESTE")) return "Wm Heredia Este";
            if (txt.includes("HEREDIA")) return "Wm Heredia";
            if (txt.includes("ALAJUELA")) return "Wm Alajuela";
            if (txt.includes("TIBAS") || txt.includes("TIBÃS")) return "Wm Tibas";
            if (txt.includes("ESCAZU") || txt.includes("ESCAZÃš")) return "Wm Escazu";
            if (txt.includes("SANTA ANA")) return "Wm Santa Ana";
            if (txt.includes("GUADALUPE")) return "Wm Guadalupe";
            if (txt.includes("DESAMPARADOS")) return "Wm Desamparados";
            return null;
        }

        function inyectarTurno(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    data.forEach(fila => {
                        const tE = buscarTiendaEnFila(fila);
                        if (tE) {
                            for (let i = 1; i <= 8; i++) {
                                const val = parseInt(fila[`Slot ${i}`] || fila[`SLOT ${i}`] || 0);
                                if (!isNaN(val)) db[tE].slots[i-1] += val;
                            }
                            const sVal = parseInt(fila["Sol"] || fila["SOL"] || fila["Soluciones"] || fila["SOLUCIONES"] || 0);
                            if (!isNaN(sVal)) db[tE].sol += sVal;
                        }
                    });
                    guardar();
                    mostrarToast(`âš¡ Turno y Soluciones inyectados`, 'success');
                    input.value = "";
                } catch (err) { mostrarToast(`âŒ Error de archivo`, 'error'); }
            };
            reader.readAsArrayBuffer(file);
        }

        function procesarArchivoGeneral(input, tipo, slotIdx = null) {
            const file = input.files[0]; if (!file) return;
            if (tipo === 'slots' && slotIdx !== null) {
                if ((locks[slotIdx + 1] || 0) >= 2) {
                    mostrarToast(`âŒ Slot ${slotIdx + 1} bloqueado (2/2)`, 'error');
                    input.value = ""; return;
                }
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let count = 0;
                data.forEach(fila => {
                    const tE = buscarTiendaEnFila(fila);
                    if (tE) {
                        if (tipo === 'slots') db[tE].slots[slotIdx]++;
                        else db[tE].sol++;
                        count++;
                    }
                });
                if (tipo === 'slots' && count > 0) locks[slotIdx + 1]++;
                guardar();
                mostrarToast(`âœ… ${count} registros cargados`, 'success');
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        function guardar() {
            localStorage.setItem('zubale_db', JSON.stringify(db));
            localStorage.setItem('zubale_locks', JSON.stringify(locks));
            actualizarUI();
        }

        function actualizarUI() {
            let b1 = 0, b2 = 0, solTotal = 0;
            allStores.forEach(name => {
                const sSum = db[name].slots.reduce((a, b) => a + b, 0);
                if (batch1Stores.includes(name)) b1 += sSum; else b2 += sSum;
                solTotal += db[name].sol;
            });
            document.getElementById('total-b1').innerText = b1.toLocaleString();
            document.getElementById('total-b2').innerText = b2.toLocaleString();
            document.getElementById('total-sols').innerText = solTotal.toLocaleString();
            document.getElementById('gran-total').innerText = (b1 + b2 + solTotal).toLocaleString();
            renderTiendas();
            actualizarEstadoBoton();
        }

        function renderTiendas() {
            const container = document.getElementById('tiendas-container');
            container.innerHTML = allStores.map(name => {
                const storeData = db[name];
                const total = storeData.slots.reduce((a, b) => a + b, 0) + storeData.sol;
                return `<div class="bg-white dark:bg-enterprise-800 p-5 rounded-2xl border border-enterprise-200 dark:border-enterprise-700 shadow-sm transition-all hover:shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-black text-[11px] text-enterprise-900 dark:text-white uppercase tracking-tighter italic">${name}</span>
                        <span class="text-xs font-black px-2 py-1 bg-accent-500/10 text-accent-500 rounded-lg">${total}</span>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        ${storeData.slots.map((v, i) => `<div class="text-[9px] text-center p-1.5 rounded-lg font-black ${v > 0 ? 'bg-emerald-500/10 text-emerald-600 border border-emerald-500/20' : 'bg-gray-50 text-gray-400 dark:bg-enterprise-900/50'}">S${i+1}</div>`).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        function exportarExcel() {
            try {
                const dataExport = allStores.map(name => {
                    const row = { "Tienda": name };
                    db[name].slots.forEach((val, i) => { row[`Slot ${i+1}`] = val; });
                    row["Soluciones"] = db[name].sol;
                    row["Total"] = db[name].slots.reduce((a, b) => a + b, 0) + db[name].sol;
                    return row;
                });
                const ws = XLSX.utils.json_to_sheet(dataExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Reporte");
                XLSX.writeFile(wb, `Reporte_Control_${new Date().toLocaleDateString()}.xlsx`);
            } catch (error) { mostrarToast("âŒ Error al exportar", "error"); }
        }

        function actualizarEstadoBoton() {
            const slot = document.getElementById('slot-selector').value;
            document.getElementById('msg-bloqueo').innerText = `Slot ${slot}: ${locks[slot] || 0}/2 Cargados`;
        }

        function limpiarTodo() {
            if(confirm("Â¿Reiniciar sistema?")) {
                localStorage.removeItem('zubale_db');
                localStorage.removeItem('zubale_locks');
                db = {}; locks = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0};
                allStores.forEach(name => db[name] = { slots: Array(8).fill(0), sol: 0 });
                guardar();
                mostrarToast("ðŸ§¹ Sistema limpio", "success");
            }
        }

        function mostrarToast(msg, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'} text-white px-5 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-2xl`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        document.getElementById('input-inyectar').addEventListener('change', function() { inyectarTurno(this); });
        document.getElementById('input-soluciones').addEventListener('change', function() { procesarArchivoGeneral(this, 'sol'); });
        document.getElementById('input-slot').addEventListener('change', function() { 
            const slotIdx = parseInt(document.getElementById('slot-selector').value) - 1;
            procesarArchivoGeneral(this, 'slots', slotIdx); 
        });

        actualizarUI();
    </script>
</body>
</html>
