<!DOCTYPE html>
<html lang="es" id="master-html" class="dark">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Zubale CR Systems | Elite Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <style>
        :root {
            --bg-main: #f1f5f9; --surface: #ffffff; --border-muted: #e2e8f0;
            --text-main: #0f172a; --primary-accent: #6366f1;
        }
        .dark {
            --bg-main: #020617; --surface: #0f172a; --border-muted: #1e293b;
            --text-main: #f8fafc;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-main);
            color: var(--text-main); letter-spacing: -0.01em; font-size: 10.5px; transition: 0.3s;
        }
        .enterprise-card { background: var(--surface); border: 1px solid var(--border-muted); border-radius: 4px; }
        .label-micro { font-size: 8.5px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700; color: #64748b; }
        .btn-elite { font-size: 9px; font-weight: 800; padding: 8px 12px; border-radius: 4px; text-transform: uppercase; cursor: pointer; text-align: center; transition: 0.2s; border: none; width: 100%; }
        .btn-primary { background: var(--primary-accent); color: white; }
        .btn-secondary { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }
        
        /* Switch Día/Noche */
        .theme-switch { width: 34px; height: 18px; background: #334155; border-radius: 20px; position: relative; cursor: pointer; }
        .theme-switch::before { content: ""; position: absolute; width: 14px; height: 14px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
        .dark .theme-switch::before { left: 18px; background: var(--primary-accent); }

        input[type="date"], select { background: var(--bg-main); border: 1px solid var(--border-muted); color: var(--text-main); font-size: 9px; padding: 4px 8px; border-radius: 4px; }
        .slot-row { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .file-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }

        /* Estilo para el Logo */
        .brand-logo { width: 32px; height: 32px; object-fit: contain; filter: drop-shadow(0 0 2px rgba(99, 102, 241, 0.5)); transition: 0.3s; }
        .dark .brand-logo { filter: brightness(1.2) drop-shadow(0 0 5px rgba(99, 102, 241, 0.8)); }
    </style>
</head>
<body class="p-4 md:p-8" onload="init()">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center enterprise-card p-5 shadow-sm">
            <div class="flex items-center gap-4">
                <img src="https://i.ibb.co/LzN2Vp9/zubale-logo-pro.png" alt="Zubale Logo" class="brand-logo">
                <div>
                    <h1 class="text-sm font-black tracking-tight uppercase">Zubale <span class="text-indigo-500 font-normal">CR Systems</span></h1>
                    <p class="label-micro italic">Elite Logistics Control Center</p>
                </div>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <div class="flex items-center gap-2 mr-2">
                    <span class="material-symbols-outlined text-slate-500 text-sm">light_mode</span>
                    <div class="theme-switch" onclick="toggleTheme()"></div>
                    <span class="material-symbols-outlined text-slate-500 text-sm">dark_mode</span>
                </div>
                <input type="date" id="fecha-selector">
                <button onclick="window.location.href='index.html'" class="btn-elite btn-secondary flex items-center gap-2 w-auto px-4">
                    <span class="material-symbols-outlined text-[12px]">home</span> Hub
                </button>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 text-center">
            <div class="enterprise-card p-3 border-t-2 border-t-[#00ff41]">
                <h3 class="label-micro">Batch 1</h3>
                <p id="total-b1" class="text-xl font-bold mt-1">0</p>
            </div>
            <div class="enterprise-card p-3 border-t-2 border-t-indigo-500">
                <h3 class="label-micro">Batch 2</h3>
                <p id="total-b2" class="text-xl font-bold mt-1">0</p>
            </div>
            <div class="enterprise-card p-3 border-t-2 border-t-orange-500">
                <h3 class="label-micro">Soluciones</h3>
                <p id="total-sols" class="text-xl font-bold mt-1">0</p>
            </div>
            <div class="enterprise-card p-3 bg-indigo-600 text-white border-none shadow-md">
                <h3 class="text-[8px] uppercase font-bold opacity-70">Total General</h3>
                <p id="gran-total" class="text-2xl font-black mt-1">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-6">
            <div class="enterprise-card p-5 lg:col-span-2">
                <h3 class="label-micro mb-3">Sincronización de Datos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                    <div class="file-wrapper">
                        <div class="btn-elite btn-secondary">Inyectar Turno Anterior</div>
                        <input type="file" onchange="inyectarTurno(this)" accept=".xlsx, .xls, .csv">
                    </div>
                    <div class="file-wrapper">
                        <div class="btn-elite bg-orange-600 text-white">Cargar Soluciones</div>
                        <input type="file" onchange="procesarArchivoGeneral(this, 'sol')" accept=".xlsx, .xls, .csv">
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-3">
                    <select id="slot-selector" onchange="actualizarEstadoBoton()" class="md:w-32">
                        <option value="1">SLOT 1</option><option value="2">SLOT 2</option><option value="3">SLOT 3</option><option value="4">SLOT 4</option>
                        <option value="5">SLOT 5</option><option value="6">SLOT 6</option><option value="7">SLOT 7</option><option value="8">SLOT 8</option>
                    </select>
                    <div class="flex-1 file-wrapper">
                        <div id="btn-label" class="btn-elite btn-primary">Subir Slot Seleccionado</div>
                        <input type="file" id="input-slot" onchange="procesarIndividual(this)" accept=".xlsx, .xls, .csv">
                    </div>
                </div>
                <p id="msg-bloqueo" class="label-micro mt-2 text-center opacity-40">Status: 0/2 Archivos</p>
            </div>
            
            <div class="enterprise-card p-5 flex flex-col justify-center gap-3 text-center">
                <h3 class="label-micro mb-1">Consolidados</h3>
                <button onclick="exportarExcel()" class="btn-elite btn-primary">Exportar Reporte Hoy</button>
                <button onclick="limpiarTodo()" class="btn-elite border border-red-500/20 text-red-500/60 hover:text-white hover:bg-red-500">Reiniciar Sistema</button>
            </div>
        </div>

        <div id="tiendas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 pb-8"></div>
    </div>

    <script>
        function toggleTheme() {
            const h = document.getElementById('master-html');
            h.classList.toggle('dark');
            localStorage.setItem('zubale_theme', h.classList.contains('dark') ? 'dark' : 'light');
        }

        const allStores = ["Wm Alajuela", "Wm Heredia", "Wm Heredia Este", "Wm Tibas", "Wm Escazu", "Wm Santa Ana", "Wm Guadalupe", "Wm Desamparados"];
        const batch1 = ["Wm Alajuela", "Wm Heredia", "Wm Heredia Este", "Wm Tibas"];
        let db = JSON.parse(localStorage.getItem('zubale_db')) || {};
        let locks = JSON.parse(localStorage.getItem('zubale_locks')) || {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0};

        function init() {
            if(localStorage.getItem('zubale_theme') === 'light') document.getElementById('master-html').classList.remove('dark');
            document.getElementById('fecha-selector').value = new Date().toISOString().split('T')[0];
            allStores.forEach(s => { if(!db[s]) db[s] = { slots: Array(8).fill(0), sol: 0 }; });
            actualizarUI();
        }

        function renderTiendas() {
            document.getElementById('tiendas-container').innerHTML = allStores.map(name => `
                <div class="enterprise-card p-3">
                    <div class="flex justify-between items-center border-b border-slate-700/10 pb-1.5 mb-2">
                        <h4 class="label-micro">${name}</h4>
                        <span class="text-base font-bold text-indigo-500">${db[name].slots.reduce((a,b)=>a+b,0) + db[name].sol}</span>
                    </div>
                    <div class="space-y-0.5">
                        ${db[name].slots.map((val, i) => `<div class="slot-row"><span>Slot ${i+1}</span><span class="font-bold">${val}</span></div>`).join('')}
                        <div class="flex justify-between items-center mt-2 pt-1.5 border-t border-slate-700/10 font-bold text-orange-500 text-[9px] uppercase">
                            <span>Soluciones</span><span>${db[name].sol}</span>
                        </div>
                    </div>
                </div>`).join('');
        }

        function buscarTiendaEnFila(fila) {
            const txt = Object.values(fila).join("|").toUpperCase();
            if (txt.includes("HEREDIA ESTE")) return "Wm Heredia Este";
            if (txt.includes("HEREDIA")) return "Wm Heredia";
            if (txt.includes("ALAJUELA")) return "Wm Alajuela";
            if (txt.includes("TIBAS") || txt.includes("TIBÁS")) return "Wm Tibas";
            if (txt.includes("ESCAZU") || txt.includes("ESCAZÚ")) return "Wm Escazu";
            if (txt.includes("SANTA ANA")) return "Wm Santa Ana";
            if (txt.includes("GUADALUPE")) return "Wm Guadalupe";
            if (txt.includes("DESAMPARADOS")) return "Wm Desamparados";
            return null;
        }

        function procesarArchivoGeneral(input, tipo, slotIdx = null) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let count = 0;
                data.forEach(fila => {
                    const tE = buscarTiendaEnFila(fila);
                    if (tE) {
                        if (tipo === 'slots' && slotIdx !== null) db[tE].slots[slotIdx]++;
                        else db[tE].sol++;
                        count++;
                    }
                });
                if (tipo === 'slots' && slotIdx !== null && count > 0) locks[slotIdx + 1]++;
                guardar();
                alert(`Procesados ${count} registros.`);
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        function procesarIndividual(input) {
            const slotSel = parseInt(document.getElementById('slot-selector').value);
            if (locks[slotSel] >= 2) { alert("SLOT BLOQUEADO"); input.value = ""; return; }
            procesarArchivoGeneral(input, 'slots', slotSel - 1);
        }

        function inyectarTurno(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                data.forEach(fila => {
                    const tE = buscarTiendaEnFila(fila);
                    if (tE) {
                        for (let i = 1; i <= 8; i++) db[tE].slots[i-1] += parseInt(fila[`Slot ${i}`] || fila[`SLOT ${i}`] || 0);
                        db[tE].sol += parseInt(fila["Sol"] || fila["SOL"] || 0);
                    }
                });
                guardar();
                alert("Turno inyectado.");
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        function guardar() {
            localStorage.setItem('zubale_db', JSON.stringify(db));
            localStorage.setItem('zubale_locks', JSON.stringify(locks));
            actualizarUI();
        }

        function actualizarUI() {
            let b1 = 0, b2 = 0, sol = 0;
            allStores.forEach(loc => {
                const sSum = db[loc].slots.reduce((a,b)=>a+b,0);
                if(batch1.includes(loc)) b1 += sSum; else b2 += sSum;
                sol += db[loc].sol;
            });
            document.getElementById('total-b1').innerText = b1;
            document.getElementById('total-b2').innerText = b2;
            document.getElementById('total-sols').innerText = sol;
            document.getElementById('gran-total').innerText = b1 + b2 + sol;
            renderTiendas();
            actualizarEstadoBoton();
        }

        function actualizarEstadoBoton() {
            const slot = document.getElementById('slot-selector').value;
            const cargados = locks[slot] || 0;
            document.getElementById('msg-bloqueo').innerText = `Slot ${slot}: ${cargados}/2 Cargados`;
            const btn = document.getElementById('btn-label');
            if (cargados >= 2) { 
                btn.className = "btn-elite bg-red-950 text-red-500 opacity-50 cursor-not-allowed"; 
                btn.innerText = "BLOQUEADO"; 
            }
            else { btn.className = "btn-elite btn-primary"; btn.innerText = "Subir Slot Seleccionado"; }
        }

        function exportarExcel() {
            const data = allStores.map(loc => ({ "Tienda": loc, ...db[loc].slots.reduce((acc, v, i) => ({...acc, [`Slot ${i+1}`]: v}), {}), "Sol": db[loc].sol, "Total": db[loc].slots.reduce((a,b)=>a+b,0) + db[loc].sol }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte");
            XLSX.writeFile(wb, `Zubale_Control_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function limpiarTodo() { if(confirm("¿Borrar todos los datos actuales?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
