<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Zubale Control - Walmart V10.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <style>
        :root { --bg: #020c1b; --card: #0a192f; --text: #e6f1ff; --border: #233554; --neon: #00ff41; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); }
        .stat-card { background: var(--card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border); }
        .btn-base { padding: 12px; border-radius: 8px; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; width: 100%; border: none; }
        .btn-blue { background: #2563eb; color: white; }
        .btn-logout { background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 6px 14px; border-radius: 8px; font-size: 10px; font-weight: 900; border: 1px solid rgba(239, 68, 68, 0.2); }
        .slot-row { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 6px 0; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body class="p-4 md:p-10" onload="init()">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center stat-card shadow-sm">
            <div class="flex items-center gap-4">
                <div class="bg-[#00ff41] p-3 rounded-lg"><span class="text-[#020c1b] font-black text-2xl">Z</span></div>
                <div>
                    <h1 class="text-2xl font-black text-[#00ff41] uppercase tracking-tighter">Zubale Control</h1>
                    <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest italic">Walmart Costa Rica</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="window.location.href='index.html'" class="btn-logout flex items-center gap-2">
                    <span class="material-symbols-outlined" style="font-size: 14px;">home</span> INICIO
                </button>
                <input type="date" id="fecha-selector" class="bg-[#112240] text-white p-2 rounded">
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
            <div class="stat-card" style="border-top: 4px solid var(--neon);">
                <h3 class="text-[10px] font-black uppercase opacity-60">Batch 1</h3>
                <p id="total-b1" class="text-4xl font-black mt-2">0</p>
            </div>
            <div class="stat-card" style="border-top: 4px solid #b388ff;">
                <h3 class="text-[10px] font-black uppercase opacity-60">Batch 2</h3>
                <p id="total-b2" class="text-4xl font-black mt-2">0</p>
            </div>
            <div class="stat-card" style="border-top: 4px solid #f59e0b;">
                <h3 class="text-[10px] font-black uppercase opacity-60">Soluciones</h3>
                <p id="total-sols" class="text-4xl font-black mt-2">0</p>
            </div>
            <div class="stat-card bg-[#00ff41] text-[#020c1b]">
                <h3 class="text-[10px] font-black uppercase opacity-70">TOTAL GENERAL</h3>
                <p id="gran-total" class="text-5xl font-black mt-2">0</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
            <div class="stat-card">
                <h3 class="text-[11px] font-black opacity-40 uppercase mb-4 tracking-widest italic">Panel de Control</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="relative">
                        <div class="btn-base bg-slate-800 text-white">Inyectar Turno Anterior</div>
                        <input type="file" onchange="inyectarTurno(this)" accept=".xlsx, .xls" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    <div class="relative">
                        <div class="btn-base bg-orange-600 text-white">Cargar Soluciones</div>
                        <input type="file" onchange="procesarSoluciones(this)" accept=".xlsx, .xls" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                </div>
                <div class="flex gap-4">
                    <select id="slot-selector" onchange="actualizarEstadoBoton()" class="w-1/3 bg-[#112240] text-white p-2 rounded">
                        <option value="1">SLOT 1</option><option value="2">SLOT 2</option><option value="3">SLOT 3</option><option value="4">SLOT 4</option>
                        <option value="5">SLOT 5</option><option value="6">SLOT 6</option><option value="7">SLOT 7</option><option value="8">SLOT 8</option>
                    </select>
                    <div class="flex-1 relative">
                        <div id="btn-label" class="btn-base btn-blue">Subir Slot Seleccionado</div>
                        <input type="file" id="input-slot" onchange="procesarSlotIndividual(this)" accept=".xlsx, .xls" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                </div>
                <p id="msg-bloqueo" class="text-[10px] font-bold opacity-40 uppercase mt-2 text-center tracking-tighter">Archivos en Slot: 0/2</p>
            </div>
            <div class="stat-card flex flex-col justify-center gap-4 text-center">
                <button onclick="exportarExcel()" class="btn-base border border-[#00ff41] text-[#00ff41]">Descargar Reporte Hoy</button>
                <button onclick="limpiarTodo()" class="btn-base border border-red-500 text-red-500">Reiniciar Dashboard</button>
            </div>
        </div>

        <div id="tiendas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 pb-20"></div>
    </div>

    <script>
        const allStores = ["Wm Alajuela", "Wm Heredia", "Wm Heredia Este", "Wm Tibas", "Wm Escazu", "Wm Santa Ana", "Wm Guadalupe", "Wm Desamparados"];
        const batch1 = ["Wm Alajuela", "Wm Heredia", "Wm Heredia Este", "Wm Tibas"];
        
        let db = JSON.parse(localStorage.getItem('zubale_db')) || {};
        let locks = JSON.parse(localStorage.getItem('zubale_locks')) || {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0};

        function init() {
            document.getElementById('fecha-selector').value = new Date().toISOString().split('T')[0];
            allStores.forEach(s => { if(!db[s]) db[s] = { slots: Array(8).fill(0), sol: 0 }; });
            actualizarUI();
            actualizarEstadoBoton();
        }

        function renderTiendas() {
            document.getElementById('tiendas-container').innerHTML = allStores.map(name => `
                <div class="stat-card" data-location="${name}">
                    <div class="flex justify-between items-center border-b border-border pb-2 mb-2">
                        <h4 class="font-black uppercase text-[10px] opacity-60">${name}</h4>
                        <span class="store-total-val text-2xl font-black text-[#00ff41]">${db[name].slots.reduce((a,b)=>a+b,0) + db[name].sol}</span>
                    </div>
                    <div class="space-y-1">
                        ${[1,2,3,4,5,6,7,8].map((v, i) => `<div class="slot-row"><span>Slot ${i+1}</span><span class="opacity-80">${db[name].slots[i]}</span></div>`).join('')}
                        <div class="slot-row mt-4 bg-slate-900 p-2 rounded-lg font-bold text-orange-500"><span>SOL</span><span>${db[name].sol}</span></div>
                    </div>
                </div>`).join('');
        }

        function inyectarTurno(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                data.forEach(fila => {
                    const tienda = fila["Tienda"] || fila["TIENDA"];
                    if (db[tienda]) {
                        for (let i = 1; i <= 8; i++) db[tienda].slots[i-1] += parseInt(fila[`Slot ${i}`] || 0);
                        db[tienda].sol += parseInt(fila["Sol"] || 0);
                    }
                });
                guardar();
                alert("Turno inyectado.");
            };
            reader.readAsArrayBuffer(file);
        }

        function procesarSoluciones(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                data.forEach(fila => {
                    const str = JSON.stringify(fila).toUpperCase();
                    let tE = allStores.find(s => str.includes(s.replace("Wm ", "").toUpperCase()));
                    if (tE) db[tE].sol++;
                });
                guardar();
                alert("Soluciones cargadas.");
            };
            reader.readAsArrayBuffer(file);
        }

        function procesarSlotIndividual(input) {
            const slotSel = parseInt(document.getElementById('slot-selector').value);
            if (locks[slotSel] >= 2) return;
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                data.forEach(fila => {
                    const str = JSON.stringify(fila).toUpperCase();
                    let tE = allStores.find(s => str.includes(s.replace("Wm ", "").toUpperCase()));
                    if (tE) db[tE].slots[slotSel-1]++;
                });
                locks[slotSel]++;
                guardar();
            };
            reader.readAsArrayBuffer(file);
        }

        function guardar() {
            localStorage.setItem('zubale_db', JSON.stringify(db));
            localStorage.setItem('zubale_locks', JSON.stringify(locks));
            actualizarUI();
            actualizarEstadoBoton();
        }

        function actualizarUI() {
            let b1 = 0, b2 = 0, sol = 0;
            allStores.forEach(loc => {
                const sSum = db[loc].slots.reduce((a,b)=>a+b,0);
                if(batch1.includes(loc)) b1 += sSum; else b2 += sSum;
                sol += db[loc].sol;
            });
            document.getElementById('total-b1').innerText = b1;
            document.getElementById('total-b2').innerText = b2;
            document.getElementById('total-sols').innerText = sol;
            document.getElementById('gran-total').innerText = b1 + b2 + sol;
            renderTiendas();
        }

        function actualizarEstadoBoton() {
            const slot = document.getElementById('slot-selector').value;
            const cargados = locks[slot] || 0;
            document.getElementById('msg-bloqueo').innerText = `Archivos en Slot ${slot}: ${cargados}/2`;
            const btn = document.getElementById('btn-label');
            if (cargados >= 2) {
                btn.className = "btn-base bg-red-600 opacity-50 cursor-not-allowed";
                btn.innerText = "BLOQUEADO";
            } else {
                btn.className = "btn-base btn-blue";
                btn.innerText = "Subir Slot Seleccionado";
            }
        }

        function exportarExcel() {
            const data = allStores.map(loc => ({ "Tienda": loc, ...db[loc].slots.reduce((acc, v, i) => ({...acc, [`Slot ${i+1}`]: v}), {}), "Sol": db[loc].sol, "Total": db[loc].slots.reduce((a,b)=>a+b,0) + db[loc].sol }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte");
            XLSX.writeFile(wb, "Reporte_Zubale.xlsx");
        }

        function limpiarTodo() { if(confirm("Â¿Reiniciar todo?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
