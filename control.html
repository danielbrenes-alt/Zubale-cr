<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Zubale | Optimizaci√≥n Geo-Radial</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet" />

    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { ps: { 500: '#4F46E5', 600: '#4338CA' } } } } }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: all .4s ease; }
        .dark body { background: #020617; color: white; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }
        #map { height: 450px; border-radius: 2rem; z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .pilot-card { border-left: 8px solid; transition: all 0.3s; }
        summary::-webkit-details-marker { display: none; }
        summary { list-style: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen antialiased">

    <header class="sticky top-0 z-50 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md">
        <div class="max-w-[1440px] mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center justify-center px-4 h-10 bg-ps-600 hover:bg-ps-700 text-white font-black italic rounded-xl shadow-lg transition-all active:scale-95 cursor-pointer no-underline group">
                    <span class="mr-2 opacity-70 group-hover:opacity-100">üè†</span>
                    HUB
                </a>

                <div class="h-8 w-[1px] bg-slate-200 dark:bg-slate-700 mx-1"></div>

                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-800 dark:bg-white dark:text-slate-900 rounded-lg flex items-center justify-center text-white font-black italic shadow-lg">PS</div>
                    <div>
                        <h1 class="font-black uppercase tracking-tighter text-lg italic leading-none text-slate-800 dark:text-white">Zubale Logistic</h1>
                        <span class="text-[8px] uppercase font-bold text-ps-500 tracking-widest">Geo-Radial Slicing Engine</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="location.reload()" class="px-4 py-2 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-ps-600 hover:text-white border border-slate-200 dark:border-slate-700 italic transition-all">
                    Reiniciar
                </button>
                <button onclick="document.documentElement.classList.toggle('dark')" class="p-2 w-10 h-10 flex items-center justify-center rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    üåì
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-[1440px] mx-auto px-6 py-8 space-y-6">
        <div id="statsSummary" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass p-5 rounded-[2rem] text-center shadow-lg">
                <p class="text-[9px] font-black uppercase text-slate-400 italic">Total Pedidos</p>
                <h4 id="totalOrdersCount" class="text-3xl font-black text-ps-600 leading-none">0</h4>
            </div>
            <div class="glass p-5 rounded-[2rem] text-center shadow-lg">
                <p class="text-[9px] font-black uppercase text-slate-400 italic">Clubes Activos</p>
                <h4 id="totalClubsCount" class="text-3xl font-black text-ps-600 leading-none">0</h4>
            </div>
            <div class="glass p-5 rounded-[2rem] text-center shadow-lg">
                <p class="text-[9px] font-black uppercase text-slate-400 italic">Total Pilotos</p>
                <h4 id="totalPilotsCount" class="text-3xl font-black text-ps-600 leading-none">0</h4>
            </div>
            <div class="glass p-5 rounded-[2rem] text-center shadow-lg">
                <p class="text-[9px] font-black uppercase text-slate-400 italic">Promedio x Piloto</p>
                <h4 id="avgOrdersCount" class="text-3xl font-black text-ps-600 leading-none">0</h4>
            </div>
        </div>

        <section id="dropZone" class="glass rounded-[2.5rem] p-12 text-center border-2 border-dashed border-ps-500/20 hover:border-ps-500/50 transition-all cursor-pointer shadow-xl" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls" />
            <div class="space-y-4">
                <div class="w-16 h-16 bg-ps-600/10 rounded-full flex items-center justify-center mx-auto text-ps-600">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" stroke-width="2"></path></svg>
                </div>
                <h2 class="font-black text-xl uppercase italic tracking-tighter text-slate-800 dark:text-white">Cargar Reporte</h2>
                <p class="text-slate-400 text-[10px] uppercase font-bold tracking-widest italic">Optimizaci√≥n de sectores por Piloto</p>
            </div>
        </section>

        <div id="geoProgress" class="hidden glass rounded-3xl p-8 shadow-2xl">
            <div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="progressBar" class="bg-ps-600 h-full w-0 transition-all duration-500"></div>
            </div>
            <p id="progressText" class="text-center text-[9px] font-black uppercase mt-3 text-ps-600 italic">Calculando m√©tricas y posiciones...</p>
        </div>

        <div id="mainUI" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-6">
                <div id="map"></div>
                <div id="routesContainer" class="space-y-4"></div>
            </div>
            
            <div class="lg:col-span-4">
                <div class="glass p-8 rounded-[2.5rem] sticky top-24 space-y-6 shadow-2xl">
                    <h3 class="font-black text-xs uppercase tracking-widest text-ps-600 italic">Asignaci√≥n de Pilotos</h3>
                    <div id="storeSettings" class="space-y-3"></div>
                    <div class="pt-6 border-t border-slate-200 dark:border-slate-800 space-y-3">
                        <button onclick="optimizarRutas()" class="w-full py-4 bg-ps-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:brightness-110 active:scale-95 italic shadow-lg">Recalcular Zonas</button>
                        <button onclick="exportarExcel()" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:brightness-110 active:scale-95 italic shadow-lg">Descargar Reporte</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const CLUB_CENTERS = { 'ALAJUELA': [10.012, -84.212], 'ESCAZU': [9.936, -84.131], 'HEREDIA': [9.998, -84.127], 'SANTA ANA': [9.932, -84.183], 'TRES RIOS': [9.905, -83.987], 'ZAPOTE': [9.921, -84.053], 'LIBERIA': [10.631, -85.438], 'CARTAGO': [9.863, -83.911], 'LLORENTE': [9.962, -84.072] };
        const COLORS = ["#4F46E5", "#EF4444", "#10B981", "#F59E0B", "#8B5CF6", "#EC4899", "#06B6D4", "#14B8A6"];
        let RAW_DATA = [];
        let map;

        function getDistanceKM(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(2);
        }

        window.onload = () => {
            map = L.map('map').setView([9.93, -84.08], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        };

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, defval: ""});
                RAW_DATA = [];
                for (let i = 1; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r[2]) continue;
                    const h = String(r[15]).match(/(\d{1,2})/) ? String(r[15]).match(/(\d{1,2})/)[1] : "00";
                    RAW_DATA.push({
                        id: String(r[2]), club: r[8], slot: h.padStart(2, '0') + ":00",
                        cliente: r[26], direccion: r[27], telf: r[28], lat: null, lon: null, piloto: 0, dist: 0
                    });
                }
                document.getElementById('dropZone').classList.add('hidden');
                await geocodeAll();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        async function geocodeAll() {
            document.getElementById("geoProgress").classList.remove("hidden");
            for (let i = 0; i < RAW_DATA.length; i++) {
                const item = RAW_DATA[i];
                const cached = localStorage.getItem(item.direccion);
                if (cached) {
                    const c = JSON.parse(cached);
                    item.lat = c.lat; item.lon = c.lon;
                } else {
                    try {
                        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.direccion)}&limit=1`);
                        const j = await r.json();
                        if (j[0]) {
                            item.lat = parseFloat(j[0].lat); item.lon = parseFloat(j[0].lon);
                            localStorage.setItem(item.direccion, JSON.stringify({lat: item.lat, lon: item.lon}));
                        } else { item.lat = 9.93; item.lon = -84.08; }
                    } catch (e) { item.lat = 9.93; item.lon = -84.08; }
                    await new Promise(r => setTimeout(r, 450));
                }
                const clubName = item.club.split('-').pop().trim().toUpperCase();
                const center = CLUB_CENTERS[clubName] || [9.93, -84.13];
                item.dist = getDistanceKM(center[0], center[1], item.lat, item.lon);
                document.getElementById("progressBar").style.width = Math.round(((i + 1) / RAW_DATA.length) * 100) + "%";
            }
            renderConfigs();
        }

        function renderConfigs() {
            document.getElementById("geoProgress").classList.add("hidden");
            document.getElementById("mainUI").classList.remove("hidden");
            document.getElementById("statsSummary").classList.remove("hidden");
            setTimeout(() => map.invalidateSize(), 400);
            
            const container = document.getElementById("storeSettings");
            container.innerHTML = '';
            const clubs = [...new Set(RAW_DATA.map(d => d.club.split('-').pop().trim().toUpperCase()))];
            
            clubs.forEach(c => {
                const orders = RAW_DATA.filter(d => d.club.toUpperCase().includes(c)).length;
                container.innerHTML += `
                    <div class="bg-slate-100 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="flex justify-between mb-2 italic font-black text-[10px] uppercase">
                            <span class="text-ps-600">${c} <span class="text-slate-400 ml-1">(${orders} Pedidos)</span></span>
                            <span id="v-${c}" class="dark:text-slate-300">2 Pilotos</span>
                        </div>
                        <input type="range" id="p-${c}" min="1" max="10" value="2" class="w-full accent-ps-600" 
                            oninput="updatePilotCount('${c}', this.value)">
                    </div>`;
            });
            updateStats();
            optimizarRutas(); 
        }

        function updatePilotCount(club, val) {
            document.getElementById(`v-${club}`).textContent = val + ' Pilotos';
            updateStats();
        }

        function updateStats() {
            const clubs = [...new Set(RAW_DATA.map(d => d.club.split('-').pop().trim().toUpperCase()))];
            let totalPilotos = 0;
            clubs.forEach(c => {
                totalPilotos += parseInt(document.getElementById(`p-${c}`).value);
            });

            document.getElementById('totalOrdersCount').textContent = RAW_DATA.length;
            document.getElementById('totalClubsCount').textContent = clubs.length;
            document.getElementById('totalPilotsCount').textContent = totalPilotos;
            document.getElementById('avgOrdersCount').textContent = (RAW_DATA.length / totalPilotos).toFixed(1);
        }

        function optimizarRutas() {
            map.eachLayer(l => { if (l instanceof L.CircleMarker) map.removeLayer(l); });
            const container = document.getElementById('routesContainer');
            container.innerHTML = "";
            const clubs = [...new Set(RAW_DATA.map(d => d.club.split('-').pop().trim().toUpperCase()))];
            
            clubs.forEach(clubName => {
                const nP = parseInt(document.getElementById(`p-${clubName}`).value);
                let clubOrders = RAW_DATA.filter(d => d.club.toUpperCase().includes(clubName));
                const center = CLUB_CENTERS[clubName] || [9.93, -84.13];

                const ordersBySlot = {};
                clubOrders.forEach(o => {
                    if (!ordersBySlot[o.slot]) ordersBySlot[o.slot] = [];
                    o.angle = Math.atan2(o.lat - center[0], o.lon - center[1]);
                    ordersBySlot[o.slot].push(o);
                });

                const pilotRoutes = Array.from({ length: nP }, () => []);
                const sortedSlots = Object.keys(ordersBySlot).sort();

                sortedSlots.forEach(slotKey => {
                    const slotOrders = ordersBySlot[slotKey];
                    slotOrders.sort((a, b) => a.angle - b.angle);

                    const total = slotOrders.length;
                    const size = Math.floor(total / nP);
                    let extra = total % nP;

                    let current = 0;
                    for (let pIdx = 0; pIdx < nP; pIdx++) {
                        const batchSize = size + (extra > 0 ? 1 : 0);
                        extra--;
                        const pBatch = slotOrders.slice(current, current + batchSize);
                        pBatch.forEach(o => {
                            o.piloto = pIdx + 1;
                            pilotRoutes[pIdx].push(o);
                        });
                        current += batchSize;
                    }
                });

                const detail = document.createElement('details');
                detail.className = "glass rounded-[2.5rem] overflow-hidden shadow-xl border-none mb-4";
                let storeContent = `<div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white/20 dark:bg-slate-900/40">`;

                pilotRoutes.forEach((pOrders, pIdx) => {
                    if (pOrders.length === 0) return;
                    const color = COLORS[pIdx % COLORS.length];
                    pOrders.forEach(o => {
                        L.circleMarker([o.lat, o.lon], { radius: 7, color: color, fillOpacity: 0.9, weight: 2 }).addTo(map);
                    });

                    storeContent += `
                        <div class="pilot-card p-5 bg-white dark:bg-slate-800 rounded-3xl border-l-8 shadow-sm italic" style="border-color: ${color}">
                            <h5 class="font-black text-[10px] uppercase mb-4 text-slate-400">Piloto ${pIdx+1} (${pOrders.length} Envios)</h5>
                            <div class="space-y-4">
                                ${pOrders.map(o => `
                                    <div class="text-[11px]">
                                        <div class="flex justify-between mb-1">
                                            <span class="font-black text-ps-600">#${o.id}</span>
                                            <span class="text-[9px] font-bold text-slate-400">${o.slot}</span>
                                        </div>
                                        <p class="font-black text-[12px] uppercase leading-none mb-1 text-slate-800 dark:text-slate-200">${o.cliente}</p>
                                        <p class="text-[9px] text-slate-400 italic mb-3 line-clamp-1">${o.direccion}</p>
                                        <div class="flex gap-2">
                                            <a href="https://waze.com/ul?ll=${o.lat},${o.lon}&navigate=yes" target="_blank" class="flex-1 bg-sky-400 text-white py-2 rounded-xl text-center font-black text-[8px] uppercase tracking-widest">Waze</a>
                                            <a href="https://www.google.com/maps?q=${o.lat},${o.lon}" target="_blank" class="flex-1 bg-ps-600 text-white py-2 rounded-xl text-center font-black text-[8px] uppercase tracking-widest">Maps</a>
                                        </div>
                                    </div>`).join('<hr class="my-4 border-slate-100 dark:border-slate-700/50">')}
                            </div>
                        </div>`;
                });

                storeContent += `</div>`;
                detail.innerHTML = `<summary class="p-6 flex justify-between items-center cursor-pointer italic select-none">
                    <div class="flex items-center gap-4">
                        <div class="w-11 h-11 bg-ps-600 rounded-2xl flex items-center justify-center text-white font-black shadow-lg">PS</div>
                        <div>
                            <h3 class="font-black text-lg uppercase tracking-tighter text-slate-800 dark:text-white">${clubName}</h3>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${nP} Pilotos asignados</p>
                        </div>
                    </div>
                    <div class="bg-slate-900 dark:bg-ps-600 text-white font-black text-[9px] px-5 py-2 rounded-2xl uppercase tracking-widest">${clubOrders.length} Envios</div>
                </summary>${storeContent}`;
                container.appendChild(detail);
            });
            const group = new L.featureGroup(Object.values(map._layers).filter(l => l instanceof L.CircleMarker));
            if (group.getLayers().length > 0) map.fitBounds(group.getBounds().pad(0.1));
        }

        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            const clubs = [...new Set(RAW_DATA.map(d => d.club.split('-').pop().trim().toUpperCase()))];
            clubs.forEach(cName => {
                const data = RAW_DATA.filter(d => d.club.toUpperCase().includes(cName))
                    .sort((a,b) => a.slot.localeCompare(b.slot) || a.piloto - b.piloto)
                    .map(o => {
                        let row = { 'PILOTO': o.piloto, 'ID': o.id, 'SLOT': o.slot, 'CLIENTE': o.cliente, 'DIRECCION': o.direccion, 'TEL': o.telf };
                        if (cName === 'LIBERIA') row['DISTANCIA_KM'] = parseFloat(o.dist);
                        return row;
                    });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), cName.substring(0,31));
            });
            XLSX.writeFile(wb, `PriceSmart_Rutas_Optimizadas.xlsx`);
        }
    </script>
</body>
</html>
