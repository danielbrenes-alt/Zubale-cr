<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Zubale Pro - Master Command Center</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <style>
        :root { 
            --dark-bg: #020c1b; --dark-sidebar: #010812; --dark-card: #0a192f; 
            --neon-green: #00ff41; --white: #e6f1ff; --red: #ff3333; 
        }
        body { font-family: 'Manrope', sans-serif; background-color: var(--dark-bg); color: var(--white); margin: 0; overflow-x: hidden; }
        
        /* Sidebar Styles */
        .sidebar { background: var(--dark-sidebar); border-right: 1px solid #112240; width: 240px; height: 100vh; position: fixed; padding: 30px 20px; display: flex; flex-direction: column; z-index: 50; }
        .main-content { margin-left: 240px; padding: 40px; }
        
        /* Botones de Navegaci√≥n */
        .btn-nav { 
            background: rgba(0, 255, 65, 0.05); color: var(--white); border: 1px solid #233554;
            padding: 12px; border-radius: 12px; text-align: left; font-weight: 700; cursor: pointer; 
            margin-bottom: 10px; font-size: 11px; text-transform: uppercase; width: 100%; 
            display: flex; align-items: center; gap: 12px; transition: 0.3s;
        }
        .btn-nav:hover { border-color: var(--neon-green); color: var(--neon-green); background: rgba(0, 255, 65, 0.1); }
        .btn-nav.active { background: var(--neon-green); color: black; border-color: var(--neon-green); }

        /* Card Styles */
        .ai-card { background: var(--dark-card); border-radius: 16px; padding: 20px; border: 1px solid #233554; transition: 0.3s; min-height: 180px; display: flex; flex-direction: column; justify-content: space-between; opacity: 0.2; }
        .ai-card.active { border-color: var(--neon-green); box-shadow: 0 10px 25px rgba(0,255,65,0.1); opacity: 1 !important; }
        
        .big-number { font-size: 38px; font-weight: 800; color: var(--neon-green); line-height: 1; }
        .label-small { font-size: 9px; color: #8892b0; font-weight: 700; text-transform: uppercase; }
        
        input[type="number"] { background: rgba(2, 12, 27, 0.8); border: 1px solid #233554; color: white; width: 50px; border-radius: 6px; font-weight: 800; text-align: center; font-size: 12px; }
        
        .btn-red { background: var(--red); color: white; padding: 12px; border-radius: 8px; text-align: center; font-weight: 800; cursor: pointer; margin-bottom: 20px; font-size: 11px; text-transform: uppercase; border: none; width: 100%; transition: 0.2s; }
        .btn-red:hover { filter: brightness(1.2); }
        
        .btn-neon-outline { background: transparent; color: var(--neon-green); padding: 10px; border-radius: 8px; text-align: center; font-weight: 800; cursor: pointer; margin-top: 10px; font-size: 10px; text-transform: uppercase; border: 1px solid var(--neon-green); width: 100%; transition: 0.2s; }
        .btn-neon-outline:hover { background: var(--neon-green); color: black; }
        
        #modal-rutas { display: none; position: fixed; inset: 0; background: rgba(2, 12, 27, 0.9); backdrop-filter: blur(8px); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: var(--dark-card); width: 100%; max-width: 1000px; max-height: 85vh; border-radius: 20px; border: 1px solid #233554; overflow-y: auto; padding: 30px; }
        
        .hour-badge { background: var(--neon-green); color: black; padding: 4px 12px; border-radius: 4px; font-weight: 800; font-size: 11px; display: inline-block; margin-bottom: 10px; }
    </style>
</head>
<body onload="init()">

<div class="sidebar">
    <div class="mb-8">
        <h1 style="font-weight: 800; font-size: 18px; color: var(--neon-green);">ZUBALE<span style="color:white">PRO</span></h1>
        <p style="font-size: 9px; color: #8892b0; letter-spacing: 2px; font-weight: 600;">MASTER CONTROL</p>
    </div>

    <nav class="flex-1">
        <p class="label-small mb-4" style="font-size: 8px;">Navegaci√≥n</p>
        <button onclick="window.location.href='index.html'" class="btn-nav">
            <span class="material-symbols-outlined text-sm">home</span> Hub Principal
        </button>
        <button onclick="window.location.href='sedes.html'" class="btn-nav">
            <span class="material-symbols-outlined text-sm">location_on</span> Cambiar Sede
        </button>
        <button class="btn-nav active">
            <span class="material-symbols-outlined text-sm">analytics</span> Procesador
        </button>
    </nav>
    
    <button onclick="limpiarDashboard()" class="btn-red">üóëÔ∏è Limpiar Datos</button>

    <div style="background: rgba(0, 255, 65, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(0, 255, 65, 0.1);">
        <p class="label-small">Total General</p>
        <p id="global-count" style="font-size: 28px; font-weight: 800; color: white;">0</p>
        <p style="font-size: 9px; color: #8892b0; margin-top: 5px;">√çtems Procesados</p>
    </div>
    
    <button id="btn-export-master" onclick="exportarTodasLasTiendas()" style="display:none; margin-top: 15px;" class="btn-neon-outline">üì¶ Exportar Todo</button>
</div>

<div class="main-content">
    <div class="flex justify-between items-center mb-10">
        <h2 id="display-sede" class="text-4xl font-black tracking-tighter uppercase">Consolidado de Sedes</h2>
        <div class="text-right">
            <p class="label-small">Estado del Sistema</p>
            <p class="text-xs font-bold text-primary">LIVE MONITORING</p>
        </div>
    </div>

    <div id="drop-zone" style="border: 2px dashed #233554; padding: 40px; border-radius: 20px; text-align: center; cursor: pointer; margin-bottom: 30px; background: rgba(17, 34, 64, 0.2);" onclick="document.getElementById('file-input').click()">
        <input type="file" id="file-input" style="display: none;" onchange="procesarArchivo(this)">
        <span class="material-symbols-outlined" style="font-size: 48px; color: var(--neon-green);">upload_file</span>
        <p style="font-weight: 800; margin-top: 10px; font-size: 18px;">SOLTAR EXCEL PROCESADO AQU√ç</p>
        <p style="font-size: 11px; color: #8892b0; margin-top: 5px;">Lectura autom√°tica de Tiendas, IDs y Ventanas Horarias</p>
    </div>

    <div id="clubs-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px;"></div>
</div>

<div id="modal-rutas">
    <div class="modal-box">
        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #112240; padding-bottom: 15px; margin-bottom: 20px; align-items: center;">
            <h2 id="modal-titulo" style="font-weight: 800; color: var(--neon-green); font-size: 20px;">HOJA DE DESPACHO</h2>
            <button onclick="document.getElementById('modal-rutas').style.display='none'" style="color:white; background:var(--red); border:none; padding:8px 20px; border-radius:8px; font-weight:800; cursor:pointer; font-size: 12px;">CERRAR VENTANA</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
    const sedes = ["Alajuela", "Cartago", "Escazu", "Heredia", "Liberia", "Llorente", "Tres Rios", "Zapote"];
    let dbMaestra = [];

    // Capturar sede de la URL si existe
    const urlParams = new URLSearchParams(window.location.search);
    const sedeActual = urlParams.get('sede');

    function init() {
        if(sedeActual) {
            document.getElementById('display-sede').innerText = "Sede: " + sedeActual;
        }

        const grid = document.getElementById('clubs-grid');
        grid.innerHTML = sedes.map(s => `
            <div class="ai-card" id="card-${s.toLowerCase()}">
                <h3 style="font-weight: 800; font-size: 14px; color: #8892b0; border-bottom: 1px solid #112240; padding-bottom: 10px; margin-bottom: 15px;">${s.toUpperCase()}</h3>
                <div id="info-${s.toLowerCase()}" style="display: none;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
                        <div><p class="label-small">Pedidos</p><p id="count-${s.toLowerCase()}" class="big-number">0</p></div>
                        <div style="text-align:right"><p class="label-small">Pilotos</p><input type="number" id="pilotos-${s.toLowerCase()}" value="4"></div>
                    </div>
                    <button class="btn-neon-outline" onclick="verRutas('${s}')">Configurar Rutas</button>
                </div>
            </div>
        `).join('');
    }

    function limpiarDashboard() {
        if(confirm("¬øDesea borrar los datos actuales del monitor?")) {
            dbMaestra = [];
            document.getElementById('global-count').innerText = "0";
            document.getElementById('btn-export-master').style.display = "none";
            document.getElementById('file-input').value = "";
            sedes.forEach(s => {
                document.getElementById(`card-${s.toLowerCase()}`).classList.remove('active');
                document.getElementById(`info-${s.toLowerCase()}`).style.display = "none";
            });
        }
    }

    function procesarArchivo(input) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1}); 

            dbMaestra = [];
            for(let i = 1; i < rawData.length; i++) {
                const f = rawData[i];
                if (f && f.length > 5) {
                    dbMaestra.push({
                        tienda: String(f[8] || ""),   
                        id: String(f[2] || ""),       
                        hora: String(f[15] || ""),    
                        cliente: String(f[26] || ""), 
                        direccion: String(f[28] || ""), 
                        telefono: String(f[27] || "")   
                    });
                }
            }
            document.getElementById('global-count').innerText = dbMaestra.length;
            document.getElementById('btn-export-master').style.display = "block";
            recalcularVisuales();
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function recalcularVisuales() {
        sedes.forEach(s => {
            const filtrados = dbMaestra.filter(p => p.tienda.toUpperCase().includes(s.toUpperCase()));
            const card = document.getElementById(`card-${s.toLowerCase()}`);
            const info = document.getElementById(`info-${s.toLowerCase()}`);
            
            if (filtrados.length > 0) {
                card.classList.add('active');
                info.style.display = "block";
                document.getElementById(`count-${s.toLowerCase()}`).innerText = filtrados.length;
            }
        });
    }

    function calcularAsignacion(sede) {
        const nPilotos = parseInt(document.getElementById(`pilotos-${sede.toLowerCase()}`).value) || 1;
        const pedidos = dbMaestra.filter(p => p.tienda.toUpperCase().includes(sede.toUpperCase()));
        const gruposHora = {};
        
        pedidos.forEach(p => {
            const match = p.hora.match(/(\d{1,2}):(\d{2})/);
            const h = match ? match[1] + ":" + match[2] : "Pendiente";
            if (!gruposHora[h]) gruposHora[h] = [];
            gruposHora[h].push(p);
        });

        const horas = Object.keys(gruposHora).sort();
        let resultado = [];
        horas.forEach(h => {
            const list = gruposHora[h];
            const tam = Math.ceil(list.length / nPilotos);
            for(let i = 0; i < nPilotos; i++) {
                const ruta = list.slice(i * tam, (i + 1) * tam);
                if (ruta.length > 0) {
                    resultado.push({ hora: h, piloto: i + 1, datos: ruta });
                }
            }
        });
        return resultado;
    }

    function verRutas(sede) {
        const asignacion = calcularAsignacion(sede);
        const body = document.getElementById('modal-body');
        body.innerHTML = "";
        let horaActual = null;
        
        asignacion.forEach(g => {
            if (g.hora !== horaActual) {
                horaActual = g.hora;
                body.innerHTML += `<div style="margin:25px 0 10px 0;"><span class="hour-badge">VENTANA ${horaActual}</span></div>`;
            }
            let html = `<div style="background:rgba(2,12,27,0.4); border:1px solid #233554; border-radius:12px; padding:15px; margin-bottom:12px; border-left:4px solid var(--neon-green);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <p style="font-weight:900; color:var(--neon-green); font-size:11px;">PILOTO #${g.piloto}</p>
                    <p style="font-size:10px; color:#8892b0; font-weight:800;">${g.datos.length} PEDIDOS</p>
                </div>`;
            g.datos.forEach((p, idx) => {
                html += `<p style="font-size:10px; color:#e6f1ff; margin-bottom:4px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:4px;">
                    <span style="color:var(--neon-green); font-weight:800;">${idx+1}.</span> ${p.cliente} <span style="color:#8892b0;">| ID: ${p.id}</span>
                </p>`;
            });
            html += `</div>`;
            body.innerHTML += html;
        });
        document.getElementById('modal-rutas').style.display = "flex";
    }

    function exportarTodasLasTiendas() {
        const wb = XLSX.utils.book_new();
        let hayDatos = false;
        sedes.forEach(sede => {
            const card = document.getElementById(`card-${sede.toLowerCase()}`);
            if (card.classList.contains('active')) {
                hayDatos = true;
                const asignacion = calcularAsignacion(sede);
                const rows = asignacion.flatMap(g => g.datos.map((p, idx) => ({
                    "Ventana": g.hora,
                    "Piloto": "Piloto " + g.piloto,
                    "Orden": idx + 1,
                    "ID Pedido": p.id,
                    "Cliente": p.cliente,
                    "Tel√©fono": p.telefono,
                    "Direcci√≥n": p.direccion
                })));
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb_name = sede.substring(0, 31);
                XLSX.utils.book_append_sheet(wb, ws, wb_name);
            }
        });
        if (hayDatos) {
            XLSX.writeFile(wb, "Rutas_Consolidadas_PriceMart.xlsx");
        } else {
            alert("No hay datos cargados para exportar.");
        }
    }
</script>
</body>
</html>
