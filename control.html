<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Zubale | Geo-Radial Engine</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet" />

    <script>
        tailwind.config = { 
            darkMode: 'class', 
            theme: { extend: { colors: { ps: { 500: '#4F46E5', 600: '#4338CA' } } } } 
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background 0.4s, color 0.4s; }
        .dark body { background: #020617; color: white; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.05); }
        #map { height: 500px; border-radius: 2.5rem; z-index: 10; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        .pilot-card { border-left: 8px solid; transition: transform 0.2s; }
        .pilot-card:hover { transform: translateY(-2px); }
        summary::-webkit-details-marker { display: none; }
        summary { list-style: none; }
        input[type="range"] { accent-color: #4F46E5; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen antialiased">

    <header class="sticky top-0 z-50 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md">
        <div class="max-w-[1440px] mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center px-4 h-10 bg-ps-600 text-white font-black italic rounded-xl shadow-lg">
                    <span class="mr-2"></span> HUB
                </div>
                <div class="h-8 w-[1px] bg-slate-200 dark:bg-slate-700 mx-1"></div>
                <div>
                    <h1 class="font-black uppercase tracking-tighter text-lg italic leading-none text-slate-800 dark:text-white">Zubale Logistic</h1>
                    <span class="text-[8px] uppercase font-bold text-ps-500 tracking-widest">Optimizaci贸n Geo-Radial v3.0</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="location.reload()" class="px-4 py-2 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-xl font-black text-[10px] uppercase border border-slate-200 dark:border-slate-700 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">Reiniciar</button>
                <button onclick="document.documentElement.classList.toggle('dark')" class="p-2 w-10 h-10 flex items-center justify-center rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-sm text-xl"></button>
            </div>
        </div>
    </header>

    <main class="max-w-[1440px] mx-auto px-6 py-8 space-y-6">
        
        <div id="statsSummary" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass p-5 rounded-[2rem] text-center shadow-lg"><p class="text-[9px] font-black uppercase text-slate-400 italic">Total Pedidos</p><h4 id="totalOrdersCount" class="text-3xl font-black text-ps-600">0</h4></div>
            <div class="glass p-5 rounded-[2rem] text-center shadow-lg"><p class="text-[9px] font-black uppercase text-slate-400 italic">Clubes Activos</p><h4 id="totalClubsCount" class="text-3xl font-black text-ps-600">0</h4></div>
            <div class="glass p-5 rounded-[2rem] text-center shadow-lg"><p class="text-[9px] font-black uppercase text-slate-400 italic">Pilotos Totales</p><h4 id="totalPilotsCount" class="text-3xl font-black text-ps-600">0</h4></div>
            <div class="glass p-5 rounded-[2rem] text-center shadow-lg"><p class="text-[9px] font-black uppercase text-slate-400 italic">Eficiencia (P/P)</p><h4 id="avgOrdersCount" class="text-3xl font-black text-ps-600">0</h4></div>
        </div>

        <section id="dropZone" class="glass rounded-[2.5rem] p-16 text-center border-2 border-dashed border-ps-500/30 hover:border-ps-500 transition-all cursor-pointer shadow-2xl group" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls" />
            <div class="space-y-4">
                <div class="w-20 h-20 bg-ps-600/10 rounded-full flex items-center justify-center mx-auto text-ps-600 group-hover:scale-110 transition-transform">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                </div>
                <h2 class="font-black text-2xl uppercase italic text-slate-800 dark:text-white">Cargar Reporte de Pedidos</h2>
                <p class="text-slate-400 text-xs font-bold tracking-[0.2em] uppercase italic">Procesamiento autom谩tico de rutas y geolocalizaci贸n</p>
            </div>
        </section>

        <div id="geoProgress" class="hidden glass rounded-[2rem] p-10 shadow-2xl">
            <div class="w-full bg-slate-200 dark:bg-slate-700 h-3 rounded-full overflow-hidden">
                <div id="progressBar" class="bg-ps-600 h-full w-0 transition-all duration-300"></div>
            </div>
            <p id="progressText" class="text-center text-[10px] font-black uppercase mt-4 text-ps-600 italic tracking-widest animate-pulse">Analizando coordenadas geogr谩ficas...</p>
        </div>

        <div id="mainUI" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-6">
                <div id="map"></div>
                <div id="routesContainer" class="space-y-4"></div>
            </div>
            
            <div class="lg:col-span-4">
                <div class="glass p-8 rounded-[2.5rem] sticky top-24 space-y-6 shadow-2xl border-none">
                    <div class="flex items-center justify-between">
                        <h3 class="font-black text-xs uppercase tracking-widest text-ps-600 italic">Configuraci贸n de Flota</h3>
                        <span class="px-2 py-1 bg-ps-600/10 text-ps-600 text-[8px] font-black rounded-md uppercase">Live Editor</span>
                    </div>
                    
                    <div id="storeSettings" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2 custom-scrollbar">
                        </div>

                    <div class="pt-6 border-t border-slate-200 dark:border-slate-800 space-y-3">
                        <button onclick="optimizarRutas()" class="w-full py-4 bg-ps-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:brightness-110 active:scale-95 italic shadow-lg transition-all">
                            Actualizar Mapa
                        </button>
                        <button onclick="exportarExcel()" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:brightness-110 active:scale-95 italic shadow-lg transition-all">
                            Exportar Reporte Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Configuraci贸n de Centrales (Costa Rica)
        const CLUB_CENTERS = { 
            'ALAJUELA': [10.012, -84.212], 'ESCAZU': [9.936, -84.131], 
            'HEREDIA': [9.998, -84.127], 'SANTA ANA': [9.932, -84.183], 
            'TRES RIOS': [9.905, -83.987], 'ZAPOTE': [9.921, -84.053], 
            'LIBERIA': [10.631, -85.438], 'CARTAGO': [9.863, -83.911], 
            'LLORENTE': [9.962, -84.072] 
        };

        const COLORS = ["#4F46E5", "#EF4444", "#10B981", "#F59E0B", "#8B5CF6", "#EC4899", "#06B6D4", "#14B8A6"];
        let RAW_DATA = [];
        let map;

        // Distancia Haversine
        function getDistanceKM(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(2);
        }

        window.onload = () => {
            map = L.map('map', { zoomControl: false }).setView([9.93, -84.08], 11);
            L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
        };

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, defval: ""});
                RAW_DATA = [];
                
                for (let i = 1; i < rows.length; i++) {
                    const r = rows[i];
                    if (!r[2]) continue; // Salta si no hay ID de pedido
                    
                    // Normalizar Slot de tiempo (Columna 15)
                    const h = String(r[15]).match(/(\d{1,2})/) ? String(r[15]).match(/(\d{1,2})/)[1] : "00";
                    
                    RAW_DATA.push({
                        id: String(r[2]), 
                        club: r[8], 
                        slot: h.padStart(2, '0') + ":00",
                        cliente: r[26], 
                        direccion: r[27], 
                        telf: r[28], 
                        lat: null, lon: null, piloto: 0, dist: 0
                    });
                }
                document.getElementById('dropZone').classList.add('hidden');
                await geocodeAll();
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        async function geocodeAll() {
            document.getElementById("geoProgress").classList.remove("hidden");
            const total = RAW_DATA.length;
            
            for (let i = 0; i < total; i++) {
                const item = RAW_DATA[i];
                const cached = localStorage.getItem(item.direccion);
                
                if (cached) {
                    const c = JSON.parse(cached);
                    item.lat = c.lat; item.lon = c.lon;
                } else {
                    try {
                        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.direccion + ", Costa Rica")}&limit=1`);
                        const j = await r.json();
                        if (j[0]) {
                            item.lat = parseFloat(j[0].lat); item.lon = parseFloat(j[0].lon);
                            localStorage.setItem(item.direccion, JSON.stringify({lat: item.lat, lon: item.lon}));
                        } else { item.lat = 9.93; item.lon = -84.08; }
                    } catch (e) { item.lat = 9.93; item.lon = -84.08; }
                    await new Promise(r => setTimeout(r, 450)); // Delay para evitar bloqueo API
                }
                
                const clubName = item.club.split('-').pop().trim().toUpperCase();
                const center = CLUB_CENTERS[clubName] || [9.93, -84.13];
                item.dist = getDistanceKM(center[0], center[1], item.lat, item.lon);
                
                document.getElementById("progressBar").style.width = Math.round(((i + 1) / total) * 100) + "%";
            }
            renderConfigs();
        }

        function renderConfigs() {
            document.getElementById("geoProgress").classList.add("hidden");
            document.getElementById("mainUI").classList.remove("hidden");
            document.getElementById("statsSummary").classList.remove("hidden");
            setTimeout(() => map.invalidateSize(), 400);
            
            const container = document.getElementById("storeSettings");
            container.innerHTML = '';
            const clubs = [...new Set(RAW_DATA.map(d => d.club.split('-').pop().trim().toUpperCase()))];
            
            clubs.forEach(c => {
                const orders = RAW_DATA.filter(d => d.club.toUpperCase().includes(c)).length;
                container.innerHTML += `
                    <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="flex justify-between mb-3 italic font-black text-[10px] uppercase">
                            <span class="text-ps-600">${c} <span class="text-slate-400 ml-1">(${orders} Pedidos)</span></span>
                            <span id="v-${c}" class="dark:text-slate-300 font-bold bg-white dark:bg-slate-700 px-2 py-1 rounded-lg shadow-sm">2 Pilotos</span>
                        </div>
                        <input type="range" id="p-${c}" min="1" max="20" value="2" class="w-full" oninput="updatePilotCount('${c}', this.value)">
                    </div>`;
            });
            updateStats();
            optimizarRutas(); 
        }

        function updatePilotCount(club, val) {
            document.getElementById(`v-${club}`).textContent = val + ' Pilotos';
            updateStats();
            optimizarRutas(); 
        }

        function updateStats() {
            const clubs = [...new Set(RAW_DATA.map(d => d.club.split('-').pop().trim().toUpperCase()))];
            let totalPilotos = 0;
            clubs.forEach(c => {
                const slider = document.getElementById(`p-${c}`);
                if(slider) totalPilotos += parseInt(slider.value);
            });
            document.getElementById('totalOrdersCount').textContent = RAW_DATA.length;
            document.getElementById('totalClubsCount').textContent = clubs.length;
            document.getElementById('totalPilotsCount').textContent = totalPilotos;
            document.getElementById('avgOrdersCount').textContent = (RAW_DATA.length / (totalPilotos || 1)).toFixed(1);
        }

        function optimizarRutas() {
            // Limpiar Mapa
            map.eachLayer(l => { if (l instanceof L.CircleMarker) map.removeLayer(l); });
            const container = document.getElementById('routesContainer');
            container.innerHTML = "";
            const clubs = [...new Set(RAW_DATA.map(d => d.club.split('-').pop().trim().toUpperCase()))];
            
            clubs.forEach(clubName => {
                const slider = document.getElementById(`p-${clubName}`);
                const nP = slider ? parseInt(slider.value) : 2;
                let clubOrders = RAW_DATA.filter(d => d.club.toUpperCase().includes(clubName));
                const center = CLUB_CENTERS[clubName] || [9.93, -84.13];

                const ordersBySlot = {};
                clubOrders.forEach(o => {
                    if (!ordersBySlot[o.slot]) ordersBySlot[o.slot] = [];
                    // C谩lculo de 谩ngulo radial respecto al club
                    o.angle = Math.atan2(o.lat - center[0], o.lon - center[1]);
                    ordersBySlot[o.slot].push(o);
                });

                const pilotRoutes = Array.from({ length: nP }, () => []);
                Object.keys(ordersBySlot).sort().forEach(slotKey => {
                    const slotOrders = ordersBySlot[slotKey].sort((a, b) => a.angle - b.angle);
                    const total = slotOrders.length;
                    const size = Math.floor(total / nP);
                    let extra = total % nP;
                    let current = 0;
                    
                    for (let pIdx = 0; pIdx < nP; pIdx++) {
                        const batchSize = size + (extra > 0 ? 1 : 0);
                        extra--;
                        slotOrders.slice(current, current + batchSize).forEach(o => { 
                            o.piloto = pIdx + 1; 
                            pilotRoutes[pIdx].push(o); 
                        });
                        current += batchSize;
                    }
                });

                // Renderizar Resultados
                const detail = document.createElement('details');
                detail.className = "glass rounded-[2.5rem] overflow-hidden shadow-xl border-none mb-6";
                let storeContent = `<div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 bg-white/30 dark:bg-slate-900/40">`;

                pilotRoutes.forEach((pOrders, pIdx) => {
                    if (pOrders.length === 0) return;
                    const color = COLORS[pIdx % COLORS.length];
                    pOrders.forEach(o => L.circleMarker([o.lat, o.lon], { radius: 7, color: color, fillColor: color, fillOpacity: 0.9, weight: 2 }).addTo(map));
                    
                    storeContent += `
                        <div class="pilot-card p-5 bg-white dark:bg-slate-800 rounded-3xl shadow-sm italic" style="border-color: ${color}">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-black text-[10px] uppercase text-slate-400">Piloto ${pIdx+1}</h5>
                                <span class="bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-[9px] font-black">${pOrders.length} Envios</span>
                            </div>
                            <div class="space-y-4">
                                ${pOrders.map(o => `
                                    <div class="text-[11px] group">
                                        <div class="flex justify-between mb-1">
                                            <span class="font-black text-ps-600">#${o.id}</span>
                                            <span class="text-[9px] font-bold text-slate-400">${o.slot}</span>
                                        </div>
                                        <p class="font-black text-[12px] uppercase leading-none mb-1 text-slate-800 dark:text-slate-200">${o.cliente}</p>
                                        <p class="text-[9px] text-slate-400 italic mb-3 line-clamp-1">${o.direccion}</p>
                                        <div class="flex gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                            <a href="https://waze.com/ul?ll=${o.lat},${o.lon}&navigate=yes" target="_blank" class="flex-1 bg-sky-400 text-white py-2 rounded-xl text-center font-black text-[8px] uppercase tracking-widest">Waze</a>
                                            <a href="https://www.google.com/maps/search/?api=1&query=${o.lat},${o.lon}" target="_blank" class="flex-1 bg-ps-600 text-white py-2 rounded-xl text-center font-black text-[8px] uppercase tracking-widest">Maps</a>
                                        </div>
                                    </div>`).join('<hr class="my-4 border-slate-100 dark:border-slate-700/50">')}
                            </div>
                        </div>`;
                });

                detail.innerHTML = `
                    <summary class="p-6 flex justify-between items-center cursor-pointer italic select-none hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-ps-600 rounded-2xl flex items-center justify-center text-white font-black shadow-lg">Z</div>
                            <div>
                                <h3 class="font-black text-xl uppercase tracking-tighter text-slate-800 dark:text-white">${clubName}</h3>
                                <p class="text-[9px] font-bold text-ps-500 uppercase tracking-widest">${nP} Pilotos asignados</p>
                            </div>
                        </div>
                        <div class="bg-slate-900 dark:bg-ps-600 text-white font-black text-[10px] px-6 py-2 rounded-2xl uppercase tracking-[0.2em] shadow-lg">${clubOrders.length} PEDIDOS</div>
                    </summary>
                    ${storeContent}</div>`;
                container.appendChild(detail);
            });
            
            const markers = Object.values(map._layers).filter(l => l instanceof L.CircleMarker);
            if (markers.length > 0) map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
        }

        function exportarExcel() {
            const wb = XLSX.utils.book_new();
            const clubs = [...new Set(RAW_DATA.map(d => d.club.split('-').pop().trim().toUpperCase()))];
            
            clubs.forEach(cName => {
                const data = RAW_DATA.filter(d => d.club.toUpperCase().includes(cName))
                    .sort((a,b) => a.slot.localeCompare(b.slot) || a.piloto - b.piloto)
                    .map(o => ({
                        'PILOTO': o.piloto, 
                        'PEDIDO_ID': o.id, 
                        'VENTANA': o.slot, 
                        'CLIENTE': o.cliente, 
                        'DIRECCION': o.direccion, 
                        'DIST_EST_KM': o.dist,
                        'TEL': o.telf
                    }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), cName.substring(0,31));
            });
            XLSX.writeFile(wb, `Logistica_Zubale_Plan.xlsx`);
        }
    </script>
</body>
</html>
