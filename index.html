<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Zubale Pro CR - Control Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        .card { border-radius: 16px; border: 1px solid #e2e8f0; transition: transform 0.2s; }
        .dark body { background-color: #020617; color: #f1f5f9; }
        .dark .card { background-color: #0f172a; border-color: #1e293b; }
        .slot-full { background-color: #ef4444 !important; opacity: 0.7; cursor: not-allowed !important; }
        .editable-cell { cursor: cell; transition: all 0.2s; }
        .table-resumen th { font-size: 10px; text-transform: uppercase; padding: 10px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .table-resumen td { padding: 10px; text-align: center; border-bottom: 1px solid #f1f5f9; font-weight: bold; font-size: 13px; }
        #loading-overlay { display: none; position: fixed; top: 20px; right: 20px; z-index: 100; }
        .btn-main { height: 40px; border-radius: 8px; font-weight: 900; font-size: 10px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; }
    </style>
</head>
<body class="p-6 bg-slate-50 text-slate-700">

    <div id="loading-overlay" class="bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg text-xs font-bold animate-pulse uppercase">
        Actualizando...
    </div>

    <div class="bg-white p-6 rounded-2xl border shadow-sm dark:bg-slate-900 dark:border-slate-800 mb-8">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <div class="lg:col-span-5 space-y-3">
                <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">Carga de Archivos</h2>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex flex-col items-center justify-center h-24 border-2 border-dashed border-slate-200 rounded-xl hover:bg-slate-50 cursor-pointer dark:border-slate-700">
                        <span class="material-symbols-outlined text-slate-400">history</span>
                        <span class="text-[9px] font-bold uppercase mt-1">Anterior</span>
                        <input type="file" class="hidden" onchange="procesarArchivo(this, 'anterior')">
                    </label>
                    <div class="space-y-2">
                        <div class="flex gap-1">
                            <select id="slot-selector" onchange="verificarBloqueoSlot()" class="w-24 h-11 border rounded-lg px-2 font-black text-xs bg-slate-50 dark:bg-slate-800">
                                <option value="1">Slot 1</option><option value="2">Slot 2</option><option value="3">Slot 3</option><option value="4">Slot 4</option>
                                <option value="5">Slot 5</option><option value="6">Slot 6</option><option value="7">Slot 7</option><option value="8">Slot 8</option>
                            </select>
                            <label id="btn-subir-slot" class="flex-1 bg-blue-600 text-white btn-main cursor-pointer hover:bg-blue-700">
                                <span class="material-symbols-outlined text-sm">upload</span> <span id="text-subir">Subir</span>
                                <input type="file" id="input-slot" class="hidden" onchange="procesarArchivo(this, 'slot')">
                            </label>
                        </div>
                        <label class="w-full bg-amber-500 text-white btn-main cursor-pointer hover:bg-amber-600">
                            <span class="material-symbols-outlined text-sm">task_alt</span> Soluciones
                            <input type="file" class="hidden" onchange="procesarArchivo(this, 'solucion')">
                        </label>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-3">
                <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">Descargas Inmediatas</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="descargarExcelLocal()" class="bg-emerald-600 text-white btn-main hover:bg-emerald-700">Excel Diario</button>
                    <button onclick="descargarReporte('SEMANAL')" class="bg-slate-700 text-white btn-main hover:bg-slate-800">Semanal</button>
                    <button onclick="descargarReporte('MENSUAL')" class="bg-indigo-600 text-white btn-main hover:bg-indigo-700">Mensual</button>
                    <button onclick="limpiarDatosDia()" class="border-2 border-red-200 text-red-500 btn-main hover:bg-red-50">Limpiar</button>
                </div>
            </div>

            <div class="lg:col-span-3 space-y-3 text-center">
                <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest border-b pb-2">Fecha</h2>
                <input type="date" id="fecha-selector" onchange="cambiarFecha()" class="w-full h-11 border-2 border-blue-100 rounded-lg px-2 font-black text-center text-blue-600 dark:bg-slate-800">
            </div>
        </div>
    </div>

    <div class="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="tiendas-container"></div>

    <div class="bg-white p-6 rounded-2xl border shadow-sm dark:bg-slate-900 dark:border-slate-800">
        <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest border-b pb-4 mb-4">Detalle y Edición</h2>
        <div class="overflow-x-auto">
            <table class="w-full table-resumen" id="tabla-export">
                <thead>
                    <tr>
                        <th class="text-left pl-4">Tienda</th>
                        <th>S1</th><th>S2</th><th>S3</th><th>S4</th><th>S5</th><th>S6</th><th>S7</th><th>S8</th>
                        <th class="text-amber-600">Sols</th>
                        <th class="bg-blue-50 dark:bg-slate-800 text-blue-600">Total</th>
                    </tr>
                </thead>
                <tbody id="body-consolidado"></tbody>
            </table>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzA4Segqpkbd6-2UmFOtkqwGihgBeJT9r0p6KADkoX_YXukdpFj9Hd0mNe32fWMDi94/exec";
        const allStores = ["Wm Alajuela", "Wm Heredia", "Wm Heredia Este", "Wm Tibas", "Wm Escazu", "Wm Santa Ana", "Wm Guadalupe", "Wm Desamparados"];
        
        let localData = JSON.parse(localStorage.getItem('zubale_cache')) || {};
        let slotCounters = JSON.parse(localStorage.getItem('zubale_counters')) || {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0};

        function init() {
            if(!document.getElementById('fecha-selector').value) {
                document.getElementById('fecha-selector').value = new Date().toISOString().split('T')[0];
            }
            renderTiendas();
            actualizarUI(); // Carga lo que hay en memoria local de inmediato
            fetchData();
            setInterval(fetchData, 10000); // Actualización cada 10 segundos
        }

        async function fetchData() {
            const fecha = document.getElementById('fecha-selector').value;
            try {
                const res = await fetch(`${WEB_APP_URL}?fecha=${fecha}`);
                const data = await res.json();
                if (data && data.tiendas) {
                    localData = data.tiendas;
                    slotCounters = data.counters || slotCounters;
                    // Guardar en memoria local del navegador
                    localStorage.setItem('zubale_cache', JSON.stringify(localData));
                    localStorage.setItem('zubale_counters', JSON.stringify(slotCounters));
                    actualizarUI();
                }
            } catch (e) { console.warn("Sincronizando..."); }
        }

        function actualizarUI() {
            allStores.forEach(loc => {
                const info = localData[loc] || { slots: Array(8).fill(0), sol: 0 };
                const card = document.querySelector(`[data-location="${loc}"]`);
                if(card) {
                    card.querySelector('.sol-val').innerText = info.sol;
                    card.querySelector('.grand-total').innerText = info.slots.reduce((a,b)=>a+b,0) + info.sol;
                }
            });
            renderTabla();
            verificarBloqueoSlot();
        }

        function renderTabla() {
            const tbody = document.getElementById('body-consolidado');
            tbody.innerHTML = allStores.map(loc => {
                const info = localData[loc] || { slots: Array(8).fill(0), sol: 0 };
                const total = info.slots.reduce((a,b)=>a+b,0) + info.sol;
                return `<tr><td class="text-left pl-4 font-bold italic text-slate-500">${loc}</td>
                    ${info.slots.map((s, i) => `<td contenteditable="true" class="editable-cell" onblur="guardarManual('${loc}', ${i+1}, this)">${s}</td>`).join('')}
                    <td contenteditable="true" class="editable-cell text-amber-600" onblur="guardarManual('${loc}', 'SOL', this)">${info.sol}</td>
                    <td class="bg-blue-50 dark:bg-slate-800 text-blue-600 font-black">${total}</td></tr>`;
            }).join('');
        }

        function procesarArchivo(input, tipo) {
            const file = input.files[0];
            if (!file) return;
            document.getElementById('loading-overlay').style.display = 'block';
            const slotSel = document.getElementById('slot-selector').value;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type:'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const counts = {}; allStores.forEach(l => counts[l] = 0);

                json.forEach(row => {
                    const rs = JSON.stringify(row).toUpperCase();
                    if (rs.includes("HEREDIA ESTE")) counts["Wm Heredia Este"]++;
                    else if (rs.includes("HEREDIA")) counts["Wm Heredia"]++;
                    else allStores.forEach(l => { if (!l.includes("Heredia") && rs.includes(l.replace("Wm ", "").toUpperCase())) counts[l]++; });
                });

                for (const t of allStores) {
                    if (counts[t] > 0) {
                        if (!localData[t]) localData[t] = { slots: Array(8).fill(0), sol: 0 };
                        if (tipo === 'slot') localData[t].slots[slotSel-1] += counts[t];
                        else if (tipo === 'solucion') localData[t].sol += counts[t];
                        enviarANube(t, (tipo === 'solucion' ? 'SOL' : slotSel), (tipo === 'solucion' ? localData[t].sol : localData[t].slots[slotSel-1]));
                    }
                }
                if (tipo === 'slot') slotCounters[slotSel]++;
                localStorage.setItem('zubale_cache', JSON.stringify(localData));
                actualizarUI();
                input.value = "";
                document.getElementById('loading-overlay').style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        }

        async function enviarANube(tienda, slot, valor) {
            const fecha = document.getElementById('fecha-selector').value;
            fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ fecha, tienda, slot, valor, counters: slotCounters }) });
        }

        function descargarExcelLocal() {
            const table = document.getElementById("tabla-export");
            XLSX.writeFile(XLSX.utils.table_to_book(table), `Zubale_Diario_${document.getElementById('fecha-selector').value}.xlsx`);
        }

        async function descargarReporte(tipo) {
            const fecha = document.getElementById('fecha-selector').value;
            const downloadUrl = `${WEB_APP_URL}?action=REPORT&type=${tipo}&fecha=${fecha}`;
            const a = document.createElement("a"); a.href = downloadUrl; a.target = "_blank";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function verificarBloqueoSlot() {
            const slot = document.getElementById('slot-selector').value;
            const btn = document.getElementById('btn-subir-slot');
            const txt = document.getElementById('text-subir');
            const input = document.getElementById('input-slot');
            if (slotCounters[slot] >= 2) {
                btn.classList.add('slot-full'); txt.innerText = "FULL"; input.disabled = true;
            } else {
                btn.classList.remove('slot-full'); txt.innerText = "SUBIR"; input.disabled = false;
            }
        }

        function renderTiendas() {
            const container = document.getElementById('tiendas-container');
            container.innerHTML = allStores.map(name => `
                <div class="card bg-white dark:bg-slate-900 p-6 border-t-4 border-blue-600 shadow-sm" data-location="${name}">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-blue-800 font-black text-xs uppercase tracking-tighter">${name}</h3>
                        <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold">En Línea</span>
                    </div>
                    <div class="flex items-baseline gap-2">
                        <span class="grand-total text-3xl font-black text-slate-800 dark:text-white">0</span>
                        <span class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Total</span>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-100 dark:border-slate-800 flex justify-between items-center">
                        <span class="text-[11px] font-black text-amber-600 uppercase italic">Soluciones</span>
                        <span class="sol-val text-lg font-black text-amber-500">0</span>
                    </div>
                </div>`).join('');
        }

        function cambiarFecha() { localData = {}; renderTiendas(); fetchData(); }

        async function guardarManual(t, s, e) {
            const v = parseInt(e.innerText) || 0;
            if (!localData[t]) localData[t] = { slots: Array(8).fill(0), sol: 0 };
            if (s === 'SOL') localData[t].sol = v; else localData[t].slots[s-1] = v;
            localStorage.setItem('zubale_cache', JSON.stringify(localData));
            actualizarUI();
            enviarANube(t, s, v);
        }

        async function limpiarDatosDia() {
            if (!confirm("¿Borrar todo lo local y en la nube?")) return;
            localStorage.removeItem('zubale_cache');
            localStorage.removeItem('zubale_counters');
            localData = {}; slotCounters = {1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0};
            actualizarUI();
            fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "CLEAR", fecha: document.getElementById('fecha-selector').value }) });
        }

        init();
    </script>
</body>
</html>
