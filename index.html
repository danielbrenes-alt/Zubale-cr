<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Zubale Pro CR - Live Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        .batch-1 { border-top: 5px solid #3b82f6; }
        .batch-2 { border-top: 5px solid #8b5cf6; }
        .card { border-radius: 16px; transition: all 0.3s ease; border: 1px solid #e2e8f0; }
        .dark body { background-color: #020617; color: #f1f5f9; }
        .dark .card { background-color: #0f172a; border-color: #1e293b; }
        .dark header, .dark .control-panel, .dark .preview-card { background-color: #0f172a; border-color: #1e293b; }
        .slot-row { border-bottom: 1px solid #f1f5f9; padding: 6px 0; }
        .dark .slot-row { border-bottom-color: #1e293b; }
        [contenteditable]:focus { outline: none; background: #eff6ff; color: #1e40af; border-radius: 4px; padding: 0 4px; }
        
        .update-flash { animation: flash 1s ease; }
        @keyframes flash { 
            0% { background-color: rgba(16, 185, 129, 0.2); color: #10b981; } 
            100% { background-color: transparent; } 
        }
    </style>
</head>
<body class="p-6 bg-slate-50 text-slate-700">

    <header class="w-full mb-6 flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
        <div class="flex items-center gap-4">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSPzUiCVTPF6LznRh6EHznXelLIdGM3N6tcCA&s" class="h-8 rounded">
            <div>
                <h1 class="text-lg font-black uppercase tracking-tighter text-blue-600 dark:text-blue-400">ZUBALE CONTROL</h1>
                <span id="sync-status" class="text-[9px] font-bold text-green-500 flex items-center gap-1">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    LIVE 7s
                </span>
            </div>
        </div>
        <button onclick="document.documentElement.classList.toggle('dark')" class="p-2 rounded-full bg-slate-100 dark:bg-slate-800">
            <span class="material-symbols-outlined text-amber-500">contrast</span>
        </button>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="preview-card bg-white p-4 rounded-xl border border-blue-100 shadow-sm">
            <p class="text-[10px] font-black text-blue-500 uppercase">Total Batch 1</p>
            <p id="total-b1" class="text-2xl font-black text-slate-800 dark:text-slate-100">0</p>
        </div>
        <div class="preview-card bg-white p-4 rounded-xl border border-purple-100 shadow-sm">
            <p class="text-[10px] font-black text-purple-500 uppercase">Total Batch 2</p>
            <p id="total-b2" class="text-2xl font-black text-slate-800 dark:text-slate-100">0</p>
        </div>
        <div class="preview-card bg-amber-50 p-4 rounded-xl border border-amber-200 shadow-sm dark:bg-amber-900/10">
            <p class="text-[10px] font-black text-amber-600 uppercase">Total Soluciones</p>
            <p id="total-sols" class="text-2xl font-black text-amber-600">0</p>
        </div>
        <div class="preview-card bg-blue-600 p-4 rounded-xl border shadow-md">
            <p class="text-[10px] font-black text-blue-100 uppercase">Gran Total Pedidos</p>
            <p id="total-global-pedidos" class="text-2xl font-black text-white">0</p>
        </div>
    </div>

    <div class="control-panel w-full mb-8 grid grid-cols-1 lg:grid-cols-12 gap-4 bg-white p-5 rounded-xl border shadow-sm items-end dark:bg-slate-900">
        <div class="lg:col-span-2">
            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Fecha y Limpieza</label>
            <div class="flex gap-1">
                <input type="date" id="fecha-selector" onchange="cambiarFecha()" class="w-full h-10 border rounded-lg px-2 font-bold dark:bg-slate-800 text-xs">
                <button onclick="limpiarTodo()" class="h-10 px-2 bg-slate-100 dark:bg-slate-800 border rounded-lg text-red-500 hover:bg-red-500 hover:text-white transition-all">
                    <span class="material-symbols-outlined text-sm">delete_sweep</span>
                </button>
            </div>
        </div>
        <div class="lg:col-span-2">
            <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">Slot Activo</label>
            <select id="slot-selector" class="w-full h-10 border rounded-lg px-3 font-bold dark:bg-slate-800">
                ${[1,2,3,4,5,6,7,8].map(i => `<option value="${i}"> Slot ${i}</option>`).join('')}
            </select>
        </div>
        <div class="lg:col-span-4 flex gap-2">
            <label class="flex-1 bg-blue-600 text-white h-10 rounded-lg flex items-center justify-center gap-2 cursor-pointer font-bold text-xs uppercase hover:bg-blue-700 transition-all active:scale-95">
                <span class="material-symbols-outlined text-sm">upload_file</span> Pedidos
                <input type="file" class="hidden" accept=".xlsx, .xls" onchange="procesarArchivo(this, 'slot')">
            </label>
            <label class="flex-1 bg-amber-500 text-white h-10 rounded-lg flex items-center justify-center gap-2 cursor-pointer font-bold text-xs uppercase hover:bg-amber-600 transition-all active:scale-95">
                <span class="material-symbols-outlined text-sm">done_all</span> Sols
                <input type="file" class="hidden" accept=".xlsx, .xls" onchange="procesarArchivo(this, 'solucion')">
            </label>
        </div>
        <div class="lg:col-span-4 flex gap-2">
            <button onclick="cargarDesdeNube()" class="h-10 px-4 border rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                <span class="material-symbols-outlined text-sm">sync</span>
            </button>
            <button onclick="exportarExcel()" class="flex-1 bg-emerald-600 text-white h-10 rounded-lg font-bold text-xs uppercase hover:bg-emerald-700">Excel</button>
            <button onclick="exportarHistorico('semana')" class="flex-1 bg-red-600 text-white h-10 rounded-lg font-bold text-xs uppercase hover:bg-red-700">Semana</button>
        </div>
    </div>

    <div class="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="tiendas-container"></div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzA4Segqpkbd6-2UmFOtkqwGihgBeJT9r0p6KADkoX_YXukdpFj9Hd0mNe32fWMDi94/exec";
        const batch1Stores = ["Wm Alajuela", "Wm Heredia", "WM Heredia Este", "Wm Tibas"];
        const batch2Stores = ["Wm Escazu", "Wm Santa Ana", "Wm Guadalupe", "Wm Desamparados"];
        const allStores = [...batch1Stores, ...batch2Stores];
        let registroCargas = JSON.parse(localStorage.getItem('zubale_cargas_log')) || {};

        function init() {
            const fechaInput = document.getElementById('fecha-selector');
            if(!fechaInput.value) fechaInput.value = new Date().toISOString().split('T')[0];
            
            renderTiendas();
            cargarPersistencia();
            cargarDesdeNube();

            setInterval(() => cargarDesdeNube(), 7000);
        }

        async function cargarDesdeNube() {
            const fecha = document.getElementById('fecha-selector').value;
            if (document.activeElement.getAttribute('contenteditable') === 'true') return;

            try {
                const res = await fetch(`${WEB_APP_URL}?fecha=${fecha}`);
                const data = await res.json();
                
                if (data && Array.isArray(data)) {
                    data.forEach(r => {
                        const card = document.querySelector(`[data-location="${r.tienda}"]`);
                        if (card) {
                            const el = r.slot === "SOL" ? card.querySelector('.sol-val') : card.querySelector(`[data-slot="${r.slot}"]`);
                            if (el && el.innerText !== String(r.estado)) {
                                el.innerText = r.estado;
                                el.classList.add('update-flash');
                                setTimeout(() => el.classList.remove('update-flash'), 1000);
                            }
                        }
                    });
                    guardarEstado(false);
                }
            } catch (e) { console.log("Conectando..."); }
        }

        function guardarEstado(actualizarLocal = true) {
            const fecha = document.getElementById('fecha-selector').value;
            const fullData = {}; 
            let tP = 0, tB1 = 0, tB2 = 0, tSols = 0;

            document.querySelectorAll('.card').forEach(card => {
                const loc = card.dataset.location;
                const isB1 = batch1Stores.includes(loc);
                const slots = Array.from(card.querySelectorAll('.slot-val')).map(s => parseInt(s.innerText) || 0);
                const sol = parseInt(card.querySelector('.sol-val').innerText) || 0;
                
                const subP = slots.reduce((a, b) => a + b, 0);
                tP += subP;
                tSols += sol;
                if(isB1) tB1 += subP; else tB2 += subP;

                card.querySelector('.grand-total').innerText = subP + sol;
                fullData[loc] = { slots, sol };
            });

            document.getElementById('total-global-pedidos').innerText = tP;
            document.getElementById('total-b1').innerText = tB1;
            document.getElementById('total-b2').innerText = tB2;
            document.getElementById('total-sols').innerText = tSols;
            
            if(actualizarLocal) localStorage.setItem(`zubale_data_${fecha}`, JSON.stringify(fullData));
        }

        function renderTiendas() {
            const container = document.getElementById('tiendas-container');
            container.innerHTML = allStores.map(name => {
                const isB1 = batch1Stores.includes(name);
                return `
                <div class="card bg-white dark:bg-slate-900 p-5 ${isB1 ? 'batch-1' : 'batch-2'}" data-location="${name}">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-black text-slate-700 dark:text-slate-100 uppercase tracking-tighter">${name}</h3>
                        <span class="grand-total text-2xl font-black text-blue-600">0</span>
                    </div>
                    <div class="space-y-1">
                        ${[1,2,3,4,5,6,7,8].map(i => `
                            <div class="slot-row flex justify-between text-[11px] items-center">
                                <span class="text-slate-400 font-bold italic">Entrega ${i}</span>
                                <span contenteditable="true" oninput="manualEdit(this, '${i}')" class="slot-val font-black dark:text-slate-200" data-slot="${i}">0</span>
                            </div>`).join('')}
                    </div>
                    <div class="mt-4 p-2 bg-amber-50 dark:bg-amber-900/20 rounded-lg flex justify-between items-center text-xs">
                        <span class="font-black text-amber-700 uppercase">Sols</span>
                        <span contenteditable="true" oninput="manualEdit(this, 'SOL')" class="sol-val font-black text-amber-600">0</span>
                    </div>
                </div>`;
            }).join('');
        }

        function procesarArchivo(input, tipo) {
            const file = input.files[0];
            if (!file) return;
            const slot = document.getElementById('slot-selector').value;
            const fecha = document.getElementById('fecha-selector').value;

            if (tipo === 'slot') {
                const clave = `${fecha}_SLOT_${slot}`;
                const cargas = registroCargas[clave] || 0;
                if (cargas >= 2) { alert(`Slot ${slot} Bloqueado`); return; }
                registroCargas[clave] = cargas + 1;
                localStorage.setItem('zubale_cargas_log', JSON.stringify(registroCargas));
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                allStores.forEach(loc => {
                    const shortName = loc.replace("Wm ", "").toUpperCase().replace("WM ", "");
                    let count = 0;
                    json.forEach(row => { if (JSON.stringify(row).toUpperCase().includes(shortName)) count++; });
                    if (count > 0) {
                        const card = document.querySelector(`[data-location="${loc}"]`);
                        const el = tipo === 'slot' ? card.querySelector(`[data-slot="${slot}"]`) : card.querySelector('.sol-val');
                        el.innerText = (parseInt(el.innerText) || 0) + count;
                        enviarANube(tipo === 'slot' ? slot : 'SOL', 'auto', el.innerText, loc);
                    }
                });
                guardarEstado();
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }

        async function enviarANube(slot, batch, valor, tienda) {
            fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ fecha: document.getElementById('fecha-selector').value, slot, batch, estado: valor, tienda }) });
        }

        function cargarPersistencia() {
            const data = JSON.parse(localStorage.getItem(`zubale_data_${document.getElementById('fecha-selector').value}`));
            if (data) {
                Object.entries(data).forEach(([loc, info]) => {
                    const card = document.querySelector(`[data-location="${loc}"]`);
                    if (card) {
                        info.slots.forEach((v, i) => { card.querySelector(`[data-slot="${i+1}"]`).innerText = v; });
                        card.querySelector('.sol-val').innerText = info.sol;
                    }
                });
                guardarEstado(false);
            }
        }

        function manualEdit(el, slot) { 
            guardarEstado(true); 
            enviarANube(slot, 'manual', el.innerText, el.closest('.card').dataset.location); 
        }

        function limpiarTodo() {
            if(confirm("Â¿Resetear hoy?")) {
                const f = document.getElementById('fecha-selector').value;
                localStorage.removeItem(`zubale_data_${f}`);
                for(let i=1; i<=8; i++) delete registroCargas[`${f}_SLOT_${i}`];
                localStorage.setItem('zubale_cargas_log', JSON.stringify(registroCargas));
                location.reload();
            }
        }

        function cambiarFecha() { renderTiendas(); cargarPersistencia(); cargarDesdeNube(); }

        init();
    </script>
</body>
</html>
