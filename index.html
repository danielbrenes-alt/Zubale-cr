<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Zubale CR - Dashboard v12 Final</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: { extend: { colors: { primary: "#0f172a" } } },
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; transition: all 0.3s ease; }
        .batch-1 { border-left: 4px solid #3b82f6; }
        .batch-2 { border-left: 4px solid #8b5cf6; }
        .hidden { display: none; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen">

<nav class="sticky top-0 z-50 border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md">
    <div class="max-w-[1600px] mx-auto px-4 h-12 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSPzUiCVTPF6LznRh6EHznXelLIdGM3N6tcCA&s" alt="Logo" class="h-6 w-auto">
            <h1 class="font-bold text-sm tracking-tight">Zubale CR <span class="text-slate-400 font-normal ml-2 text-xs italic">Sincronización Total</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex gap-4 border-r pr-4 border-slate-200 dark:border-slate-800">
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Pedidos:</span>
                    <span id="total-global-pedidos" class="text-sm font-black text-blue-600">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Soluciones:</span>
                    <span id="total-global-soluciones" class="text-sm font-black text-amber-500">0</span>
                </div>
            </div>
            <button onclick="toggleTheme()" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full">
                <span id="theme-icon" class="material-symbols-outlined text-sm">dark_mode</span>
            </button>
        </div>
    </div>
</nav>

<main class="max-w-[1600px] mx-auto p-4">
    <div class="mb-6 grid grid-cols-1 md:grid-cols-12 gap-3 bg-white dark:bg-slate-900 p-3 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm items-end">
        <div class="md:col-span-2">
            <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Fecha</label>
            <input type="date" id="fecha-selector" onchange="cambiarFecha()" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-lg font-bold text-blue-600 h-9 px-2 text-xs">
        </div>
        <div class="md:col-span-2">
            <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Slot de Carga</label>
            <select id="slot-selector" class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-lg font-bold text-blue-600 h-9 text-xs">
                <option value="1">Slot 1</option><option value="2">Slot 2</option><option value="3">Slot 3</option><option value="4">Slot 4</option>
                <option value="5">Slot 5</option><option value="6">Slot 6</option><option value="7">Slot 7</option><option value="8">Slot 8</option>
            </select>
        </div>
        <div class="md:col-span-3 flex gap-2">
            <label class="flex-1 bg-blue-600 text-white h-9 rounded-lg font-bold hover:bg-blue-700 cursor-pointer flex items-center justify-center gap-1 shadow-sm text-[10px] uppercase">
                Pedidos <input type="file" id="input-slot" class="hidden" accept=".xlsx, .xls" onchange="procesarArchivo(this, 'slot')">
            </label>
            <label class="flex-1 bg-amber-500 text-white h-9 rounded-lg font-bold hover:bg-amber-600 cursor-pointer flex items-center justify-center gap-1 shadow-sm text-[10px] uppercase">
                Soluciones <input type="file" id="input-sol" class="hidden" accept=".xlsx, .xls" onchange="procesarArchivo(this, 'solucion')">
            </label>
        </div>
        <div class="md:col-span-5 grid grid-cols-3 gap-2">
            <button onclick="exportarExcel()" class="bg-emerald-600 text-white h-9 rounded-lg font-bold text-[10px] uppercase">Reporte Día</button>
            <button onclick="exportarConsolidado('semana')" class="bg-purple-600 text-white h-9 rounded-lg font-bold text-[10px] uppercase">Semanal</button>
            <button onclick="resetearTablero()" class="bg-slate-200 dark:bg-slate-800 text-red-500 h-9 rounded-lg font-bold text-[10px] uppercase">Limpiar</button>
        </div>
    </div>

    <div class="space-y-6">
        <section id="sec-batch-1">
            <div class="flex items-center gap-2 mb-3"><span class="px-3 py-0.5 bg-blue-600 text-white text-[10px] font-black rounded-full uppercase">Batch 1</span></div>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4" id="grid-batch-1"></div>
        </section>
        <section id="sec-batch-2">
            <div class="flex items-center gap-2 mb-3"><span class="px-3 py-0.5 bg-purple-600 text-white text-[10px] font-black rounded-full uppercase">Batch 2</span></div>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4" id="grid-batch-2"></div>
        </section>
    </div>
</main>

<div id="preview-modal" class="fixed inset-0 z-[100] hidden bg-slate-950/60 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl p-6 border border-slate-200 dark:border-slate-800 shadow-2xl">
        <h3 class="text-lg font-bold mb-2">Confirmar Carga</h3>
        <div id="preview-body" class="space-y-2 mb-6 max-h-64 overflow-y-auto pr-2 text-sm"></div>
        <div class="flex gap-2">
            <button onclick="confirmarCarga()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl font-bold">Confirmar</button>
            <button onclick="closeModal()" class="flex-1 bg-slate-100 dark:bg-slate-800 py-2.5 rounded-xl">Cancelar</button>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzA4Segqpkbd6-2UmFOtkqwGihgBeJT9r0p6KADkoX_YXukdpFj9Hd0mNe32fWMDi94/exec";
    const batch1Stores = ["Wm Alajuela", "Wm Heredia", "WM Heredia Este", "Wm Tibas"];
    const batch2Stores = ["Wm Escazu", "Wm Santa Ana", "Wm Guadalupe", "Wm Desamparados"];
    const allStores = [...batch1Stores, ...batch2Stores];
    let dataTemporal = {};
    let modoCarga = '';

    function init() {
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-selector').value = hoy;
        renderGroup(batch1Stores, 'grid-batch-1', 'batch-1');
        renderGroup(batch2Stores, 'grid-batch-2', 'batch-2');
        cargarPersistencia();
        cargarDesdeNube();
    }

    function renderGroup(stores, containerId, cssClass) {
        const container = document.getElementById(containerId);
        container.innerHTML = stores.map(name => `
            <div class="card bg-white dark:bg-slate-900 rounded-xl p-3 shadow-sm border border-slate-200 dark:border-slate-800 ${cssClass}" data-location="${name}">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-[11px] uppercase">${name}</h3>
                    <span class="grand-total font-black text-blue-600 text-sm">0</span>
                </div>
                <div class="grid grid-cols-4 gap-1.5 mb-3">
                    ${[1,2,3,4,5,6,7,8].map(i => `<div class="bg-slate-50 dark:bg-slate-800/40 rounded p-1 text-center"><span class="text-[7px] text-slate-400 block">S${i}</span><span contenteditable="true" oninput="manualEdit(this, '${i}')" class="slot-val font-bold text-xs" data-slot="${i}">0</span></div>`).join('')}
                </div>
                <div class="flex justify-between items-center bg-amber-50 dark:bg-amber-900/10 px-2 py-1 rounded">
                    <span class="text-[8px] font-bold text-amber-600">SOL</span>
                    <span contenteditable="true" oninput="manualEdit(this, 'SOL')" class="sol-val font-bold text-amber-600 text-xs">0</span>
                </div>
            </div>`).join('');
    }

    async function enviarANube(slot, batch, valor, tienda) {
        const fecha = document.getElementById('fecha-selector').value;
        const payload = { fecha, slot, batch, estado: valor, tienda: tienda };
        try { fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) }); } catch (e) {}
    }

    function n(t) { return !t ? "" : String(t).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim(); }

    function procesarArchivo(input, tipo) {
        const file = input.files[0];
        if (!file) return;
        modoCarga = tipo;
        const reader = new FileReader();
        reader.onload = (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            dataTemporal = {};
            allStores.forEach(loc => dataTemporal[loc] = 0);
            json.forEach(fila => {
                const texto = n(Object.values(fila).join(" "));
                for (const loc of allStores) {
                    const l = n(loc).replace("WM ", "");
                    if (texto.includes(l)) {
                        if (l === "HEREDIA" && texto.includes("HEREDIA ESTE")) continue;
                        dataTemporal[loc]++;
                        break;
                    }
                }
            });
            mostrarModal();
            input.value = "";
        };
        reader.readAsArrayBuffer(file);
    }

    function mostrarModal() {
        const body = document.getElementById('preview-body');
        body.innerHTML = Object.entries(dataTemporal).filter(e => e[1] > 0).map(e => `<div class="flex justify-between border-b py-1"><span>${e[0]}</span><span class="font-bold">+${e[1]}</span></div>`).join('');
        document.getElementById('preview-modal').classList.remove('hidden');
    }

    async function confirmarCarga() {
        const slot = document.getElementById('slot-selector').value;
        for (const loc of allStores) {
            if (dataTemporal[loc] > 0) {
                const card = document.querySelector(`[data-location="${loc}"]`);
                const celda = modoCarga === 'slot' ? card.querySelector(`[data-slot="${slot}"]`) : card.querySelector('.sol-val');
                const nuevoVal = (parseInt(celda.innerText) || 0) + dataTemporal[loc];
                celda.innerText = nuevoVal;
                await enviarANube(modoCarga === 'slot' ? slot : 'SOL', modoCarga, nuevoVal, loc);
            }
        }
        guardarEstado();
        closeModal();
    }

    function exportarExcel() {
        const fecha = document.getElementById('fecha-selector').value;
        const rows = [["Tienda", "S1", "S2", "S3", "S4", "S5", "S6", "S7", "S8", "Soluciones", "Total"]];
        document.querySelectorAll('.card').forEach(card => {
            const name = card.dataset.location;
            const slots = Array.from(card.querySelectorAll('.slot-val')).map(s => s.innerText);
            const sol = card.querySelector('.sol-val').innerText;
            const total = card.querySelector('.grand-total').innerText;
            rows.push([name, ...slots, sol, total]);
        });
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reporte");
        XLSX.writeFile(wb, `Zubale_${fecha}.xlsx`);
    }

    function guardarEstado() {
        const fecha = document.getElementById('fecha-selector').value;
        const fullData = {};
        let tP = 0, tS = 0;
        document.querySelectorAll('.card').forEach(card => {
            const loc = card.dataset.location;
            const slots = Array.from(card.querySelectorAll('.slot-val')).map(s => parseInt(s.innerText) || 0);
            const sol = parseInt(card.querySelector('.sol-val').innerText) || 0;
            const total = slots.reduce((a, b) => a + b, 0) + sol;
            tP += (total - sol); tS += sol;
            card.querySelector('.grand-total').innerText = total;
            fullData[loc] = { slots, sol };
        });
        document.getElementById('total-global-pedidos').innerText = tP;
        document.getElementById('total-global-soluciones').innerText = tS;
        localStorage.setItem(`zubale_data_${fecha}`, JSON.stringify(fullData));
    }

    function cargarPersistencia() {
        const data = JSON.parse(localStorage.getItem(`zubale_data_${document.getElementById('fecha-selector').value}`));
        if (!data) { document.querySelectorAll('.slot-val, .sol-val').forEach(e => e.innerText = "0"); return; }
        Object.entries(data).forEach(([loc, info]) => {
            const card = document.querySelector(`[data-location="${loc}"]`);
            if (card) {
                info.slots.forEach((v, i) => card.querySelector(`[data-slot="${i+1}"]`).innerText = v);
                card.querySelector('.sol-val').innerText = info.sol;
            }
        });
        guardarEstado();
    }

    async function cargarDesdeNube() { /* Lógica para jalar datos de Sheets si fuera necesario */ }
    function closeModal() { document.getElementById('preview-modal').classList.add('hidden'); }
    function cambiarFecha() { cargarPersistencia(); }
    function toggleTheme() { document.documentElement.classList.toggle('dark'); }
    function resetearTablero() { if(confirm("¿Borrar todo?")) { localStorage.clear(); location.reload(); } }
    function manualEdit(el, slot) { 
        const tienda = el.closest('.card').dataset.location;
        enviarANube(slot, 'manual', el.innerText, tienda); 
        guardarEstado(); 
    }

    init();
</script>
</body>
</html>

